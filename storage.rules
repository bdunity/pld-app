rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ========================================================================
    // PLD BDU - STORAGE SECURITY RULES
    // Protecci√≥n de archivos subidos para procesamiento batch
    // ========================================================================

    // Helper: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper: Get user's tenant ID from Custom Claims
    function getUserTenantId() {
      return request.auth.token.tenantId;
    }

    // Helper: Get user's role from Custom Claims
    function getUserRole() {
      return request.auth.token.role;
    }

    // Helper: Check if user is Super Admin
    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'SUPER_ADMIN';
    }

    // Helper: Check if user belongs to the specified tenant
    function belongsToTenant(tenantId) {
      return isAuthenticated() && getUserTenantId() == tenantId;
    }

    // ========================================================================
    // UPLOADS FOLDER
    // Path: uploads/{tenantId}/{workspaceId}/{filename}
    // Policy: Users can upload to their own tenant's folder
    // ========================================================================
    match /uploads/{tenantId}/{workspaceId}/{fileName} {
      
      // READ: User must belong to tenant OR be Super Admin
      allow read: if isSuperAdmin() || belongsToTenant(tenantId);
      
      // WRITE: User must belong to tenant and have appropriate role
      allow write: if isSuperAdmin() || (
        belongsToTenant(tenantId) && 
        (getUserRole() == 'COMPANY_ADMIN' || 
         getUserRole() == 'COMPLIANCE_OFFICER' ||
         getUserRole() == 'DATA_ENTRY')
      );
      
      // DELETE: Only admins can delete uploaded files
      allow delete: if isSuperAdmin() || (
        belongsToTenant(tenantId) && getUserRole() == 'COMPANY_ADMIN'
      );
    }

    // ========================================================================
    // PRIVATE REPORTS FOLDER (XML Reports - Signed URLs Only)
    // Path: private_reports/{tenantId}/{year}/{month}/{filename}
    // Policy: NO DIRECT ACCESS - Only via Signed URLs from Cloud Functions
    // ========================================================================
    match /private_reports/{tenantId}/{year}/{month}/{fileName} {
      // CRITICAL: Deny ALL direct access
      // Files can ONLY be accessed via Signed URLs generated by Cloud Functions
      // This ensures even if someone guesses the path, they cannot download
      allow read, write: if false;
    }

    // ========================================================================
    // DOCUMENTS FOLDER (KYC Vault - Client Documents)
    // Path: documents/{tenantId}/{workspaceId}/clients/{clientRFC}/{docType}/{filename}
    // Policy: Signed URLs for upload, no direct download access
    // Retention: 5 years minimum
    // ========================================================================
    match /documents/{tenantId}/{workspaceId}/clients/{clientRFC}/{docType}/{fileName} {
      // Read: Only via Signed URLs (deny direct access)
      allow read: if false;
      
      // Write: Via Signed URL generated by Cloud Functions
      // The URL itself contains the auth token
      allow write: if false;
    }

    // ========================================================================
    // PARTITIONS FOLDER (Internal - Cloud Functions only)
    // Path: partitions/{tenantId}/{jobId}/{partitionId}.json
    // Policy: Only Cloud Functions (admin SDK) can access
    // ========================================================================
    match /partitions/{tenantId}/{jobId}/{fileName} {
      // No client access - only admin SDK can access partitions
      allow read, write: if false;
    }

    // ========================================================================
    // EXPORTS FOLDER
    // Path: exports/{tenantId}/{workspaceId}/{filename}
    // Policy: Users can download XMLs and reports from their tenant
    // ========================================================================
    match /exports/{tenantId}/{workspaceId}/{fileName} {
      
      // READ: User must belong to tenant
      allow read: if isSuperAdmin() || belongsToTenant(tenantId);
      
      // WRITE: Only system/Cloud Functions can create exports
      allow write: if false;
    }

    // ========================================================================
    // TEMPLATES FOLDER (Global)
    // Path: templates/{filename}
    // Policy: Any authenticated user can download templates
    // ========================================================================
    match /templates/{fileName} {
      
      // READ: Any authenticated user
      allow read: if isAuthenticated();
      
      // WRITE: Only Super Admin can upload templates
      allow write: if isSuperAdmin();
    }

    // ========================================================================
    // USER AVATARS
    // Path: avatars/{userId}/{filename}
    // Policy: Users can upload their own avatar
    // ========================================================================
    match /avatars/{userId}/{fileName} {
      
      // READ: Anyone can view avatars
      allow read: if isAuthenticated();
      
      // WRITE: Only the user themselves OR admin
      allow write: if isAuthenticated() && (
        request.auth.uid == userId ||
        getUserRole() == 'SUPER_ADMIN' ||
        getUserRole() == 'COMPANY_ADMIN'
      );
    }

    // ========================================================================
    // CATCH-ALL: Deny everything else
    // ========================================================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
