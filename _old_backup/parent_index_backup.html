<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Avisos LFPIORPI - 10bet Casino (IndexedDB)</title>

    <!-- Librer√≠as externas -->
    <!-- Librer√≠as externas -->
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-functions-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Charts for Map -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <!-- Fuente: Inter (Google Fonts) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* === SYSTEM: "Piano Black & White Glass" (Hybrid) === */
        :root {
            --bg-deep: #050505;
            --container-bg: rgba(255, 255, 255, 0.95);
            /* Elegant White Glass */

            --primary: #2563eb;
            /* Strong Blue for White BG */
            --primary-glass: rgba(37, 99, 235, 0.2);
            --secondary: #475569;

            --text-main: #1e293b;
            /* Dark Slate for White BG */
            --text-muted: #64748b;

            --border-glass: rgba(255, 255, 255, 0.4);
            --border-light: rgba(0, 0, 0, 0.1);

            --radius: 16px;
            --shadow-glass: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --shadow-float: 0 10px 40px -10px rgba(0, 0, 0, 0.2);

            /* Status Colors */
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shine {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            margin: 0;
            padding: 20px;
            /* Piano Black Background */
            background: radial-gradient(circle at 50% 0%, #2a2a2a 0%, #000000 100%);
            color: var(--text-main);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Main Container - Elegant White Glass */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--container-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            box-shadow: var(--shadow-glass);
            overflow: hidden;
            animation: fadeIn 0.8s ease-out;
            position: relative;
        }

        /* Header */
        header {
            padding: 30px 40px;
            background: rgba(255, 255, 255, 0.6);
            border-bottom: 1px solid var(--border-light);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .header-title h1 {
            font-size: 2em;
            font-weight: 800;
            letter-spacing: -1px;
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-title p {
            color: var(--text-muted);
            font-size: 0.95em;
        }

        /* Confidentiality Banner */
        .confidentiality-notice {
            background: #fff1f2;
            color: #9f1239;
            padding: 10px 40px;
            font-size: 0.85em;
            font-weight: 600;
            border-bottom: 1px solid #ffe4e6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            padding: 20px 40px 0;
            background: rgba(248, 250, 252, 0.5);
            border-bottom: 1px solid var(--border-light);
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .tab:hover {
            color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
            border-radius: 8px 8px 0 0;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Glass Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 28px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
        }

        /* Glass Effect on Buttons */
        .btn-primary {
            background: rgba(37, 99, 235, 0.9);
            /* Semi-transparent Blue */
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-primary::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
            background: rgba(37, 99, 235, 1);
        }

        .btn-primary:hover::after {
            left: 100%;
            transition: 0.7s;
        }

        .btn-info {
            background: rgba(14, 165, 233, 0.1);
            color: #0284c7;
            border: 1px solid rgba(14, 165, 233, 0.2);
        }

        .btn-info:hover {
            background: rgba(14, 165, 233, 0.2);
            transform: translateY(-1px);
        }

        .btn-warning {
            background: rgba(234, 179, 8, 0.1);
            color: #ca8a04;
            border: 1px solid rgba(234, 179, 8, 0.2);
        }

        /* Main Content */
        .main-content {
            padding: 40px;
            background: #fdfdfd;
            min-height: 600px;
        }

        .section {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-float);
        }

        .section-header h2 {
            font-size: 1.5em;
            color: var(--text-main);
            font-weight: 700;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            font-size: 0.75em;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background: #f8fafc;
            color: var(--text-main);
            font-size: 1em;
            transition: 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        /* Tables */
        .data-table-container {
            border-radius: 12px;
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f1f5f9;
            padding: 16px;
            text-align: left;
            font-size: 0.8em;
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            color: var(--text-main);
            font-size: 0.95em;
        }

        tr:hover td {
            background: #f8fafc;
        }

        /* Badges & Upload */
        .badge-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 700;
        }

        .badge-status.normal {
            background: #dcfce7;
            color: #15803d;
        }

        .badge-status.aviso {
            background: #fee2e2;
            color: #b91c1c;
        }

        .badge-status.monitoreo {
            background: #fef3c7;
            color: #d97706;
        }

        .file-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: var(--radius);
            padding: 60px;
            text-align: center;
            color: var(--text-muted);
            background: #f8fafc;
            transition: 0.3s;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: #eff6ff;
        }

        /* Utils */
        .hidden {
            display: none !important;
        }

        .tab-content {
            display: none;
            margin-top: 20px;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s;
        }

        .modal-container {
            background: white;
            /* ... (keep existing) ... */
        }

        /* Interactive Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .stat-card h3 {
            font-size: 2.5em;
            font-weight: 800;
            margin-bottom: 5px;
            position: relative;
            z-index: 2;
        }

        .stat-card p {
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.9;
            position: relative;
            z-index: 2;
        }

        /* Card Variants (Gradients) */
        .card-depositos {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .card-retiros {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .card-avisos {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .card-monitoreos {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        /* Active Filter Indicator */
        .stat-card.active-filter {
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.5);
            transform: scale(1.02);
        }

        /* Glass highlight */
        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255, 255, 255, 0.2), transparent);
            pointer-events: none;
        }

        /* Pagination */
        .page-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #cbd5e1;
            background: white;
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            transition: 0.2s;
        }

        .page-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* --- LOGIN & AUTH STYLES --- */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 5, 0.4);
            backdrop-filter: blur(15px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 0.5s;
        }

        #loginOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(40px);
            padding: 40px;
            border-radius: 24px;
            width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .auth-logo {
            width: 80px;
            margin-bottom: 20px;
            border-radius: 50%;
        }

        .auth-title {
            font-size: 1.8em;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .auth-subtitle {
            color: #64748b;
            font-size: 0.9em;
            margin-bottom: 30px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-input {
            padding: 14px;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            background: rgba(255, 255, 255, 0.8);
            font-size: 1em;
            transition: 0.3s;
        }

        .auth-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        .auth-btn {
            padding: 14px;
            border-radius: 12px;
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            transition: 0.3s;
        }

        .auth-btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .auth-link {
            margin-top: 15px;
            font-size: 0.85em;
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <!-- LOGIN OVERLAY -->
        <div id="loginOverlay" class="hidden">
            <div class="auth-card" id="viewLogin">
                <img src="https://thumbs2.imgbox.com/a5/db/28bD5e7C_t.jpg" alt="Logo" class="auth-logo">
                <h2 class="auth-title">Bienvenido</h2>
                <p class="auth-subtitle">Sistema de Prevenci√≥n de Lavado de Dinero</p>
                <div class="auth-form">
                    <input type="email" id="loginEmail" class="auth-input" placeholder="Correo Electr√≥nico">
                    <input type="password" id="loginPass" class="auth-input" placeholder="Contrase√±a">
                    <button class="auth-btn" onclick="ui.handleLogin()">Iniciar Sesi√≥n</button>
                    <div class="auth-link" onclick="ui.showRecover()">¬øOlvidaste tu contrase√±a?</div>
                    <div class="auth-link hidden" id="setupLink" onclick="ui.showSetupAdmin()">Configurar Admin Inicial
                        (Solo 1a vez)</div>
                </div>
            </div>

            <!-- RECOVERY VIEW -->
            <div class="auth-card hidden" id="viewRecover" style="display:none">
                <h2 class="auth-title">Recuperar Acceso</h2>
                <p class="auth-subtitle" id="recQuestionDisplay">Ingresa tu correo para buscar tu pregunta.</p>
                <div class="auth-form">
                    <input type="email" id="recEmail" class="auth-input" placeholder="Correo Registrado"
                        onblur="ui.fetchSecurityQuestion()">
                    <input type="text" id="recAnswer" class="auth-input hidden" placeholder="Respuesta de Seguridad">
                    <input type="password" id="recNewPass" class="auth-input hidden" placeholder="Nueva Contrase√±a">
                    <button class="auth-btn hidden" id="btnRecoverInfo" onclick="ui.fetchSecurityQuestion()">Buscar
                        Usuario</button>
                    <button class="auth-btn hidden" id="btnResetPass" onclick="ui.handleRecover()">Restablecer
                        Contrase√±a</button>
                    <div class="auth-link" onclick="ui.showLogin()">Volver al Login</div>
                </div>
            </div>

            <!-- SETUP/REGISTER VIEW included in Logic via Invitation flow mostly, but Admin Setup logic handled in AuthService.init -->
        </div>

        <header>
            <div class="header-content">
                <div class="logo-container">
                    <img src="https://thumbs2.imgbox.com/a5/db/28bD5e7C_t.jpg" alt="BDU Logo">
                </div>
                <div class="header-title">
                    <h1>Sistema de Avisos PLD/FT</h1>
                    <p>SaaS Cloud Edition - v2.0</p>
                    <p style="font-size: 0.85em; opacity: 0.8;">RFC: SPE091216B35</p>
                </div>
            </div>
        </header>

        <div class="confidentiality-notice">
            <strong>üîí CONEXI√ìN SEGURA - CLOUD ENCRYPTED</strong>
            La informaci√≥n se transmite cifrada y se almacena en servidores seguros (Google Cloud).
        </div>

        <main class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('config', event)">‚öôÔ∏è Configuraci√≥n</button>
                <button class="tab" onclick="switchTab('upload', event)">üìÅ Carga de Datos</button>
                <button class="tab" onclick="switchTab('operations', event)">üìä Operaciones</button>
                <button class="tab" onclick="switchTab('monitoring', event)">üìà Monitoreo 6 Meses</button>
                <button class="tab" onclick="switchTab('kyc', event)">üë• Padr√≥n KYC</button>
                <button class="tab" onclick="switchTab('export', event)">üì§ Exportar</button>
                <button class="tab" onclick="switchTab('reports', event)">üìã Banco de Reportes</button>
                <button class="tab" onclick="switchTab('audit', event)">üõ°Ô∏è Bit√°cora (Audit)</button>
            </div>

            <!-- CONTENIDO DE TABS -->

            <!-- Configuraci√≥n -->
            <div id="tab-config" class="tab-content active">
                <!-- User Profile & Admin Panel -->
                <div class="section" id="adminPanel" style="border-left: 4px solid var(--primary);">
                    <div class="section-header">
                        <h2>üë• Gesti√≥n de Usuarios</h2>
                        <button class="btn btn-primary" style="float:right" onclick="ui.showInviteModal()">üìß Invitar
                            Usuario</button>
                    </div>
                    <div style="margin-top:20px;">
                        <p><strong>Tu Usuario:</strong> <span id="currentUserDisplay">--</span></p>
                        <p style="font-size:0.9em; color:#64748b">Como administrador, puedes invitar a otros oficiales
                            de cumplimiento.</p>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2>‚öôÔ∏è Par√°metros del Sistema</h2>
                        <div class="section">
                            <div class="section-header">
                                <h2>‚öôÔ∏è Configuraci√≥n General</h2>
                            </div>
                            <div class="form-grid">
                                <div class="form-group"><label>RFC Sujeto Obligado</label><input type="text"
                                        id="rfcSujetoObligado" value="SPE091216B35"></div>
                                <div class="form-group"><label>Raz√≥n Social</label><input type="text" id="razonSocial"
                                        value="10BET CASINO EN L√çNEA"></div>
                                <div class="form-group"><label>A√±o UMA</label>
                                    <select id="yearSelect" onchange="ui.actualizarUMA()">
                                        <option value="2025" selected>2025</option>
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                        <option value="2022">2022</option>
                                        <option value="2021">2021</option>
                                        <option value="2020">2020</option>
                                    </select>
                                </div>
                                <div class="form-group"><label>Valor UMA Diario</label><input type="number"
                                        id="umaValue" value="113.14" step="0.01"></div>
                                <div class="form-group"><label>Umbral Aviso (UMA)</label><input type="number"
                                        id="thresholdAviso" value="645"></div>
                                <div class="form-group"><label>Umbral Monitoreo (UMA)</label><input type="number"
                                        id="thresholdMonitoreo" value="325"></div>
                            </div>
                            <button class="btn btn-primary" onclick="app.guardarConfig()">üíæ Guardar
                                Configuraci√≥n</button>

                            <!-- 
                            <h3 class="mt-2" style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">üì¶
                                Respaldo de Base de Datos (Legacy)</h3>
                            <p>Esta funci√≥n solo est√° disponible en la versi√≥n Local-First. En SaaS, los respaldos son autom√°ticos en la nube.</p>
                             -->
                        </div> <!-- End Outer Section -->
                    </div> <!-- End tab-config -->

                    <!-- Carga -->
                    <div id="tab-upload" class="tab-content">
                        <div class="section">
                            <div class="section-header">
                                <h2>üìÅ Carga de Archivo Mensual</h2>
                            </div>
                            <div class="file-upload-area" id="dropExcel">
                                <div class="upload-icon">üìä</div>
                                <p>Arrastra tu archivo Excel mensual aqu√≠</p>
                                <input type="file" id="fileExcel" accept=".xlsx,.xls">
                                <div id="infoExcel" class="file-info hidden"></div>
                            </div>
                            <div class="loading" id="loadingProcess">
                                <div class="spinner"></div>
                                <p>Procesando y Guardando en Base de Datos...</p>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="app.procesarArchivo()">üîÑ Procesar e Insertar
                                    en
                                    DB</button>
                            </div>
                        </div>
                    </div>

                    <!-- Operaciones -->
                    <div id="tab-operations" class="tab-content">
                        <div class="section">
                            <div class="section-header">
                                <h2>üìä Operaciones por Periodo</h2>
                                <select id="periodoSelector" onchange="app.cargarOperacionesPeriodo()"
                                    style="padding: 5px;">
                                    <option value="">Selecciona Periodo...</option>
                                </select>
                            </div>

                            <div class="chart-container">
                                <canvas id="dashboardChart"></canvas>
                            </div>

                            <div class="stats-grid">
                                <div class="stat-card card-depositos" onclick="app.filterOperations('deposito')">
                                    <h3 id="opTotalDeps">0</h3>
                                    <p>Dep√≥sitos</p>
                                    <small>Click para filtrar</small>
                                </div>
                                <div class="stat-card card-retiros" onclick="app.filterOperations('retiro')">
                                    <h3 id="opTotalRets">0</h3>
                                    <p>Retiros</p>
                                    <small>Click para filtrar</small>
                                </div>
                                <div class="stat-card card-avisos" onclick="app.filterOperations('aviso')">
                                    <h3 id="opTotalAvisos">0</h3>
                                    <p>Avisos (&ge; 645 UMA)</p>
                                    <small>Requiere Reporte</small>
                                </div>
                                <div class="stat-card card-monitoreos" onclick="app.filterOperations('monitoreo')">
                                    <h3 id="opTotalMonitoreos">0</h3>
                                    <p>Monitoreos (&ge; 325 UMA)</p>
                                    <small>Seguimiento</small>
                                </div>
                            </div>
                            <div style="text-align: right; margin-bottom: 10px;">
                                <button class="btn btn-secondary" onclick="app.filterOperations('all')"
                                    style="font-size: 0.8em;">Limpiar Filtros</button>
                            </div>
                            <!-- Toolbar de Busqueda -->
                            <div class="search-toolbar"
                                style="display:flex; gap:10px; margin-bottom:15px; background:white; padding:15px; border-radius:12px; border:1px solid #e2e8f0; align-items:center;">
                                <div style="position:relative; flex:1; display:flex; gap:5px;">
                                    <input type="text" id="searchOps" placeholder="Buscar Usuario, ID o RFC..."
                                        style="flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                                    <button class="btn btn-primary" onclick="app.applyFilters()"
                                        style="padding: 10px 20px;">üîç
                                        Buscar</button>
                                </div>
                                <select id="filterStatus" onchange="app.applyFilters()"
                                    style="padding:10px; border:1px solid #cbd5e1; border-radius:8px; background:white;">
                                    <option value="">Todos los Estados</option>
                                    <option value="normal">üü¢ Normal</option>
                                    <option value="monitoreo">üü† Monitoreo</option>
                                    <option value="aviso">üî¥ Aviso</option>
                                </select>
                                <button class="btn btn-success" onclick="app.exportToExcel()"
                                    style="padding: 10px 15px; margin-left: auto;">üìä Exportar Excel</button>
                            </div>

                            <!-- Tablas simplificadas por espacio -->
                            <h3>Dep√≥sitos</h3>
                            <div class="table-container">
                                <table id="tableDepositos">
                                    <thead>
                                        <tr>
                                            <th>Usuario</th>
                                            <th>Nombre</th>
                                            <th>Monto Mensual</th>
                                            <th>Monto Total</th>
                                            <th>Veces Umbral</th>
                                            <th>UMA</th>
                                            <th>Email</th>
                                            <th>Tel√©fono</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                                <div class="pagination" id="pagDepositos"></div>
                            </div>
                            <h3>Retiros</h3>
                            <div class="table-container">
                                <table id="tableRetiros">
                                    <thead>
                                        <tr>
                                            <th>Usuario</th>
                                            <th>Nombre</th>
                                            <th>Monto Mensual</th>
                                            <th>Monto Total</th>
                                            <th>Veces Umbral</th>
                                            <th>UMA</th>
                                            <th>Email</th>
                                            <th>Tel√©fono</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                                <div class="pagination" id="pagRetiros"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Monitoreo -->
                    <div id="tab-monitoring" class="tab-content">
                        <div class="section">
                            <div class="section-header">
                                <h2>üìà Monitoreo 6 Meses</h2>
                            </div>
                            <p>Calculado consultando la base de datos hist√≥rica.</p>
                            <div class="btn-group">
                                <button class="btn btn-info" onclick="app.calcularMonitoreo()">üîÑ Calcular
                                    Ahora</button>
                            </div>
                            <div class="table-container">
                                <table id="tableMonitoreo">
                                    <thead>
                                        <tr>
                                            <th>Usuario</th>
                                            <th>Total Dep√≥sitos</th>
                                            <th>Total Retiros</th>
                                            <th>Acumulado UMA</th>
                                            <th>Progreso (vs 645 UMA)</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- KYC -->
                    <div id="tab-kyc" class="tab-content">
                        <div class="section">
                            <div class="section-header">
                                <h2>üë• Padr√≥n KYC (DB)</h2>
                                <span class="badge" id="totalKYC">0 clientes</span>
                            </div>

                            <!-- DASHBOARD KYC -->
                            <div
                                style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-bottom:30px;">
                                <div class="card"
                                    style="background:white; padding:15px; border-radius:12px; border:1px solid #e2e8f0; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                                    <h4 style="margin-bottom:10px; font-size:0.9em; color:#64748b;">üìç Distribuci√≥n
                                        Geogr√°fica
                                        (Estados)</h4>
                                    <div style="height:200px;"><canvas id="chartStates"></canvas></div>
                                </div>
                                <div class="card"
                                    style="background:white; padding:15px; border-radius:12px; border:1px solid #e2e8f0; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                                    <h4 style="margin-bottom:10px; font-size:0.9em; color:#64748b;">‚ößÔ∏è Distribuci√≥n por
                                        Sexo
                                    </h4>
                                    <div style="height:200px; display:flex; justify-content:center;"><canvas
                                            id="chartSex"></canvas></div>
                                </div>
                                <div class="card"
                                    style="background:white; padding:15px; border-radius:12px; border:1px solid #e2e8f0; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                                    <h4 style="margin-bottom:10px; font-size:0.9em; color:#64748b;">üéÇ Rango de Edades
                                    </h4>
                                    <div style="height:200px;"><canvas id="chartAges"></canvas></div>
                                </div>
                            </div>

                            <!-- DASHBOARD RIESGO ENR 2023 -->
                            <h3 style="margin-bottom:15px; font-size:1.1em; color:#1e293b;">‚ö° Evaluaci√≥n Nacional de
                                Riesgos
                                2023 (Por Entidad)</h3>

                            <!-- Row 1: Charts -->
                            <div
                                style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; margin-bottom:20px;">
                                <div class="card"
                                    style="background:white; padding:15px; border-radius:12px; border:1px solid #e2e8f0; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                                    <h4 style="margin-bottom:10px; font-size:0.9em; color:#64748b;">Nivel de Riesgo
                                        Global</h4>
                                    <div style="height:150px; display:flex; justify-content:center;"><canvas
                                            id="chartRiskGlobal"></canvas></div>
                                </div>
                                <div class="card"
                                    style="background:white; padding:15px; border-radius:12px; border:1px solid #e2e8f0; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                                    <h4 style="margin-bottom:10px; font-size:0.9em; color:#64748b;">‚ö†Ô∏è Zona ALTO Riesgo
                                    </h4>
                                    <div style="height:150px;"><canvas id="chartRiskHigh"></canvas></div>
                                </div>
                                <div class="card"
                                    style="background:white; padding:15px; border-radius:12px; border:1px solid #e2e8f0; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                                    <h4 style="margin-bottom:10px; font-size:0.9em; color:#64748b;">‚ö†Ô∏è Zona MEDIO Riesgo
                                    </h4>
                                    <div style="height:150px;"><canvas id="chartRiskMed"></canvas></div>
                                </div>
                                <div class="card"
                                    style="background:white; padding:15px; border-radius:12px; border:1px solid #e2e8f0; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                                    <h4 style="margin-bottom:10px; font-size:0.9em; color:#64748b;">‚úÖ Zona BAJO Riesgo
                                    </h4>
                                    <div style="height:150px;"><canvas id="chartRiskLow"></canvas></div>
                                </div>
                            </div>

                            <!-- Row 2: Map -->
                            <div class="card"
                                style="background:white; padding:20px; border-radius:12px; border:1px solid #e2e8f0; box-shadow:0 2px 5px rgba(0,0,0,0.05); margin-bottom:30px;">
                                <h4 style="margin-bottom:15px; font-size:0.9em; color:#64748b;">üó∫Ô∏è Mapa de Riesgo PLD
                                    (Usuarios
                                    por Entidad)</h4>
                                <div id="regions_div" style="width: 100%; height: 500px;"></div>
                            </div>

                            <div class="search-box"><input type="text" id="searchKYC" placeholder="Buscar..."
                                    onkeyup="ui.filtrarTabla('tableKYC', this.value)"></div>
                            <div class="table-container">
                                <table id="tableKYC">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Nombre</th>
                                            <th style="min-width:120px;">Estado</th>
                                            <th>Edad/Sexo</th>
                                            <th>Actividad Econ√≥mica</th>
                                            <th>RFC / CURP</th>
                                            <th>Direcci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                                <div class="pagination" id="pagKYC"></div>
                            </div>
                            <button class="btn btn-warning" onclick="app.eliminarTodoKYC()">üóëÔ∏è Borrar Todo el
                                Padr√≥n</button>
                        </div>
                    </div>

                    <!-- Exportar -->
                    <div id="tab-export" class="tab-content">
                        <div class="section">
                            <div class="section-header">
                                <h2>out Generar XML UIF</h2>
                            </div>
                            <p>Genera los avisos basados en el periodo seleccionado en la pesta√±a "Operaciones".</p>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="app.generarXML()">üìÑ Descargar XML</button>
                                <button class="btn btn-primary" onclick="app.generarPDF()">üìã Descargar PDF
                                    Validaci√≥n</button>
                            </div>
                        </div>
                    </div>

                    <!-- Banco de Reportes -->
                    <div id="tab-reports" class="tab-content">
                        <div class="section">
                            <div class="section-header">
                                <h2>üìã Banco de Reportes Generados</h2>
                            </div>
                            <div class="data-table-container">
                                <table id="tableReportes">
                                    <thead>
                                        <tr>
                                            <th>Fecha Generaci√≥n</th>
                                            <th>Tipo Aviso</th>
                                            <th>Archivo</th>
                                            <th>Hash (Simulado)</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Bit√°cora de Auditor√≠a -->
                    <div id="tab-audit" class="tab-content">
                        <div class="section">
                            <div class="section-header">
                                <h2>üõ°Ô∏è Bit√°cora de Auditor√≠a (Audit Log)</h2>
                                <p style="color:var(--text-muted); font-size:0.9em;">Registro inmutable de acciones
                                    cr√≠ticas del
                                    sistema.</p>
                            </div>
                            <div class="data-table-container">
                                <table id="tableAudit">
                                    <thead>
                                        <tr>
                                            <th>Fecha/Hora</th>
                                            <th>Usuario</th>
                                            <th>Acci√≥n</th>
                                            <th>Detalles</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
        </main>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast">Mensaje</div>

    <!-- MODAL -->
    <div class="modal-overlay" id="genericModal">
        <div class="modal-content">
            <span class="close-modal" onclick="ui.closeModal()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // === FIREBASE SAAS CONFIGURATION ===
        const firebaseConfig = {
            apiKey: "AIzaSyBvTwfl3C5cuXQxd3iaO3I0cuA8nIbIu1Y",
            authDomain: "pld-bdu.firebaseapp.com",
            projectId: "pld-bdu",
            storageBucket: "pld-bdu.firebasestorage.app",
            messagingSenderId: "776119551243",
            appId: "1:776119551243:web:ac90329a6c8047ec4b8e0e",
            measurementId: "G-R1R2ZJE0RK"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const fAuth = firebase.auth();
        const fStorage = firebase.storage();
        const fFunctions = firebase.functions(); // For GenerateXML

        // === DB SERVICE ADAPTER (CLOUD NATIVE) ===
        // Maps legacy calls to Firestore where possible, or warns about deprecated usage.
        const dbService = {
            listeners: {}, // Store unsubscribe functions
            currentTenantId: null,

            async init() {
                console.log('‚òÅÔ∏è SaaS Mode Initialized');
                return true;
            },

            // SaaS: Listen to a collection
            listen(collectionPath, callback) {
                if (this.listeners[collectionPath]) {
                    this.listeners[collectionPath](); // Unsubscribe prev
                }
                console.log(`üì° Listening to ${collectionPath}`);
                this.listeners[collectionPath] = db.collection(collectionPath)
                    .onSnapshot(snapshot => {
                        const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        callback(items);
                    }, error => {
                        console.error("Firestore Error:", error);
                        ui.showToast("Error de conexi√≥n: " + error.message);
                    });
            },

            // Legacy GET: Use for discrete fetches (User config, specific items)
            async get(collection, id) {
                if (collection === 'users') {
                    // In SaaS, we verify auth user, not local DB user
                    return null;
                }
                // For other items, standard fetch if needed
                try {
                    const doc = await db.collection(collection).doc(id).get();
                    return doc.exists ? doc.data() : null;
                } catch (e) { console.error(e); return null; }
            },

            // Obsolete in SaaS (Server handles writes usually, unless it's config)
            async addItems(collection, items) {
                console.warn("‚ö†Ô∏è addItems is deprecated in SaaS. Use robust server-side ingestion.");
            },

            // Used for local filtering. In SaaS, we can fetch all for the active workspace if dataset is small (<5000)
            // or use specific queries.
            async getAll(collection) {
                // If caller requests 'operations', we return current cached data from App state 
                // because we switched to Listeners.
                if (collection === 'operations') return app.currentData.operations || [];
                return [];
            }
        };

        // === APP LOGIC ===
        const app = {
            config: {},
            currentData: { depositos: [], retiros: [] }, // View only

            async init() {
                try {
                    await dbService.init();
                    await dbService.init();
                    await auth.init();

                    // TEMP: Auto-login/Bypass for testing per user request
                    document.getElementById('currentUserDisplay').textContent = "Admin (Bypass)";
                    auth.currentUser = { email: 'bypass@admin', role: 'admin' };
                    document.getElementById('adminPanel').style.display = 'block';

                    await this.cargarConfig();

                    // Restore missing data loaders
                    await this.cargarPeriodosDisponibles();
                    await this.cargarPadr√≥nKYC();
                    await this.cargarReportes();
                    await this.actualizarStats();
                    this.cargarAudit();

                    // Login is now handled by Overlay. 
                    // We do NOT log 'LOGIN' here anymore, it's done in auth.login

                    ui.actualizarUMA();
                } catch (e) {
                    console.error(e);
                    alert('Error iniciando DB: ' + e);
                }
            },

            async cargarConfig() {
                const tx = dbService.db.transaction(['config'], 'readonly');
                const store = tx.objectStore('config');
                const req = store.get('main');
                req.onsuccess = () => {
                    if (req.result) {
                        this.config = req.result;
                        ui.fillConfig(this.config);
                    } else {
                        // Default
                        this.config = { id: 'main', rfc: 'SPE091216B35', uma: 38610.00, aviso: 645, monitoreo: 325 };
                        dbService.addItems('config', [this.config]);
                        ui.fillConfig(this.config);
                    }
                };
            },

            async guardarConfig() {
                this.config = ui.getConfigFromDOM();
                this.config.id = 'main';
                await dbService.addItems('config', [this.config]);
                ui.showToast('Configuraci√≥n Guardada');
            },

            async exportarBackup() {
                const backup = {
                    config: await dbService.getAll('config'),
                    kyc: await dbService.getAll('kyc'),
                    operations: await dbService.getAll('operations'),
                    reports: await dbService.getAll('reports'),
                    timestamp: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(backup)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `PLD_Backup_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                ui.showToast('Respaldo Generado Exitosamente');
            },

            async importarBackup(input) {
                const file = input.files[0];
                if (!file) return;

                if (!confirm("‚ö†Ô∏è ADVERTENCIA: Al restaurar se eiliminar√°n los datos actuales y se reemplazar√°n con el respaldo. ¬øContinuar?")) {
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        ui.toggleLoading(true);

                        await dbService.clearStore('config');
                        await dbService.clearStore('kyc');
                        await dbService.clearStore('operations');
                        await dbService.clearStore('reports');

                        if (data.config) await dbService.addItems('config', data.config);
                        if (data.kyc) await dbService.addItems('kyc', data.kyc);
                        if (data.operations) await dbService.addItems('operations', data.operations);
                        if (data.reports) await dbService.addItems('reports', data.reports);

                        ui.toggleLoading(false);
                        ui.showToast('Restauraci√≥n Completa');
                        this.logAction('RESTAURAR_BACKUP', `Sistema restaurado desde archivo: ${file.name}`);
                        setTimeout(() => location.reload(), 1500);
                    } catch (err) {
                        ui.toggleLoading(false);
                        alert("Error al restaurar: " + err);
                    }
                };
                reader.readAsText(file);
            },

            // SaaS: Listen only
            initListeners() {
                if (!auth.currentUser || !auth.currentUser.tenantId) return;
                const tenantId = auth.currentUser.tenantId;

                // Listen to Operations
                // Note: In real app, we might listen to daily batches or paginated queries.
                // For this migration, we check the 'operations' path if it exists, or just listen to aggregation docs.
                // Since this legacy app expects full dump, we might struggle with large datasets.
                // Assuming "Small Data" (< 5000 ops) for this client view.

                dbService.listen(`tenants/${tenantId}/workspaces/operations`, (items) => {
                    console.log(`üì° Ops Update: ${items.length} records`);
                    // Sort items by date desc
                    items.sort((a, b) => new Date(b.fechaProceso) - new Date(a.fechaProceso));

                    this.currentData.depositos = items.filter(i => i.tipo === 'deposito');
                    this.currentData.retiros = items.filter(i => i.tipo === 'retiro');

                    // Update UI if we are on that tab
                    if (document.getElementById('periodoSelector').value) {
                        this.cargarOperacionesPeriodo();
                    } else {
                        // Initial render of all or stats
                        ui.renderOperaciones({ depositos: this.currentData.depositos, retiros: this.currentData.retiros });
                    }
                    ui.showToast("Datos actualizados en tiempo real");
                });

                // Listen to KYC
                /*
                dbService.listen(`tenants/${tenantId}/workspaces/kyc`, (items) => {
                    this.currentData.kyc = items;
                    ui.renderKYC(items);
                });
                */
            },

            async procesarArchivo() {
                const fileInput = document.getElementById('fileExcel');
                if (!fileInput.files.length) return alert('Selecciona archivo');
                const file = fileInput.files[0];

                if (!auth.currentUser) return alert("Debes iniciar sesi√≥n");

                ui.toggleLoading(true);
                ui.showToast("Iniciando carga segura a la nube...");

                try {
                    // Upload to Firebase Storage
                    const tenantId = auth.currentUser.tenantId;
                    const storageRef = fStorage.ref();
                    const fileRef = storageRef.child(`uploads/${tenantId}/${file.name}`);

                    const snapshot = await fileRef.put(file);
                    console.log('Uploaded a blob or file!', snapshot);

                    ui.showToast("‚úÖ Archivo subido. Procesando en la nube...");
                    this.logAction('UPLOAD_CLOUD', `Archivo subido: ${file.name}`);

                    // The Cloud Function 'onFileUploaded' will pick this up and populate Firestore
                    // The 'initListeners' below will catch the new data when it arrives.

                } catch (err) {
                    console.error("Upload Error", err);
                    alert("Error al subir: " + err.message);
                } finally {
                    ui.toggleLoading(false);
                }
            },

            parseOperaciones(rows, tipo) {
                return rows.map(r => {
                    const monto = parseFloat(tipo === 'deposito' ? (r['Monthly Depostis'] || r.H) : (r['Monthly Withdrawals'] || r.H)) || 0;
                    if (monto <= 0) return null;

                    const year = parseInt(r['Period Year'] || r.E || 2025);
                    const month = parseInt(r['Period Month'] || r.F || 1);

                    // 1. Extract and Clean Data
                    const username = String(r.USERNAME || r.C || '');
                    const playercode = String(r['playercode'] || r.B || '');
                    const nombre = String(r.FIRSTNAME || (tipo === 'deposito' ? r.K : r.J) || '').toUpperCase().trim();
                    const apellido = String(r.LASTNAME || (tipo === 'deposito' ? r.L : r.K) || '').toUpperCase().trim();

                    // 2. Parse Date of Birth
                    let dobRaw = (r.DOB || (tipo === 'deposito' ? r.O : r.N));
                    let dob;
                    if (typeof dobRaw === 'number') {
                        dob = new Date(Math.round((dobRaw - 25569) * 86400 * 1000));
                    } else {
                        dob = new Date(dobRaw);
                    }
                    if (isNaN(dob.getTime())) dob = new Date(); // Fallback to current date if invalid

                    // 3. RFC Strategy
                    let rfc = String(r.RFC || (tipo === 'deposito' ? r.Z : r.Y) || '').toUpperCase().trim();
                    if (!rfc || rfc.length < 10 || rfc.startsWith('XAXX')) {
                        const parts = apellido.split(' ');
                        const paterno = parts[0] || 'X';
                        const materno = parts.slice(1).join(' ') || '';
                        rfc = Utils.calcularRFC(nombre, paterno, materno, dob);
                        // console.log(`RFC Auto-Calculado: ${rfc}`);
                    }

                    return {
                        playercode: playercode,
                        username: username,
                        firstname: nombre,
                        lastname: apellido,
                        email: String(r.EMAIL || (tipo === 'deposito' ? r.S : r.R)).toLowerCase(),
                        phone: String(r.PHONE || (tipo === 'deposito' ? r.T : r.S)),
                        rfc: rfc,
                        curp: String(r.CURP || (tipo === 'deposito' ? r.AA : r.Z)),
                        address: String(r.ADDRESS || (tipo === 'deposito' ? r.P : r.O)),
                        zip: String(r.ZIP || (tipo === 'deposito' ? r.Q : r.P)),
                        dob: dob.toISOString(),
                        // Data Op
                        tipo: tipo,
                        monto: monto,
                        umaEq: monto / this.config.uma,
                        periodoId: year * 100 + month,
                        year, month,
                        fechaProceso: new Date().toISOString(),
                        estadoDir: Utils.getStateFromCP(String(r.ZIP || (tipo === 'deposito' ? r.Q : r.P))),
                        ocupacion: String(r.OCCUPATION || r.ACTIVIDAD || r.JOB || '').toUpperCase().trim(),
                        // New Fields
                        edad: parseInt(r.Age || r.AGE || 0),
                        sexoRaw: String(r.GENDER || r.SEX || r.SEXO || '').toUpperCase().trim()
                    };
                }).filter(Boolean);
            },

            extractKYC(op) {
                return {
                    playercode: op.playercode, // Key
                    username: op.username,
                    nombre: op.firstname,
                    apellido: op.lastname,
                    email: op.email,
                    phone: op.phone,
                    rfc: op.rfc,
                    curp: op.curp,
                    direccion: op.address,
                    cp: op.zip,
                    dob: op.dob,
                    ocupacion: op.ocupacion,
                    estado: op.estadoDir,
                    edad: op.edad,
                    sexoRaw: op.sexoRaw, // 'M' or 'F' from Excel
                    updated: new Date().toISOString()
                };
            },

            async cargarOperacionesPeriodo() {
                const pid = parseInt(document.getElementById('periodoSelector').value);
                if (!pid) return;

                const ops = await dbService.getByIndex('operations', 'periodoId', pid);

                // Save to state
                this.currentData.depositos = ops.filter(o => o.tipo === 'deposito');
                this.currentData.retiros = ops.filter(o => o.tipo === 'retiro');

                // Update Counts (Dashboard Cards)
                document.getElementById('opTotalDeps').innerText = this.currentData.depositos.length;
                document.getElementById('opTotalRets').innerText = this.currentData.retiros.length;

                // Count Alerts (>= 645)
                const avs = ops.filter(o => o.umaEq >= this.config.aviso).length;
                document.getElementById('opTotalAvisos').innerText = avs;

                // Count Monitoring (>= 325 and < 645)
                const mons = ops.filter(o => o.umaEq >= this.config.monitoreo && o.umaEq < this.config.aviso).length;
                document.getElementById('opTotalMonitoreos').innerText = mons;

                // Reset Filters on Load
                this.filterOperations('all');
            },

            async cargarPeriodosDisponibles() {
                // In a real optimized app we would have a separate store for Periods. 
                // Here we scan or just rely on user input/current loaded.
                // For now, let's keep it simple: Add current year months.
                const sel = document.getElementById('periodoSelector');
                // Persist current
                const val = sel.value;
                sel.innerHTML = '<option value="">Selecciona Periodo...</option>';
                const year = this.config.year || 2025;
                for (let i = 1; i <= 12; i++) {
                    const pid = year * 100 + i;
                    sel.innerHTML += `<option value="${pid}">${i}/${year}</option>`;
                }
                if (val) sel.value = val;
            },

            async cargarPadr√≥nKYC() {
                const clientes = await dbService.getAll('kyc');
                ui.renderKYC(clientes);
                document.getElementById('totalKYC').textContent = clientes.length + ' clientes';
            },

            async eliminarTodoKYC() {
                if (!confirm("¬øBorrar todo el padr√≥n KYC y Operaciones?")) return;
                await dbService.clearStore('kyc');
                await dbService.clearStore('operations');
                await this.cargarPadr√≥nKYC();
                this.currentData = { depositos: [], retiros: [] };
                ui.renderOperaciones(this.currentData);
                ui.showToast(' Base de Datos Limpia');
            },

            async guardarKYC(cliente) {
                await dbService.addItems('kyc', [cliente]);
                ui.showToast('Cliente Actualizado');
                this.cargarPadr√≥nKYC();
            },

            async calcularMonitoreo() {
                // Feature moved to Cloud Functions (Server-Side Calculation)
                // The frontend now only visualizes the 'operations' collection.
                ui.showToast("‚ö°Ô∏è Monitoreo calculado autom√°ticamente en la nube");
                console.log("Legacy local calculation removed. Relying on SaaS backend.");
            },

            async actualizarStats() {
                // Fetch ALL operations to count totals for dashboard badges
                const kycCount = (await dbService.getAll('kyc')).length;
                const ops = await dbService.getAll('operations');

                const depCount = ops.filter(o => o.tipo === 'deposito').length;
                const retCount = ops.filter(o => o.tipo === 'retiro').length;
                const alertCount = ops.filter(o => o.umaEq >= this.config.aviso).length;

                // Update UI Badges/Counters if they exist
                if (document.getElementById('totalDespositos')) document.getElementById('totalDespositos').innerText = depCount;
                if (document.getElementById('totalRetiros')) document.getElementById('totalRetiros').innerText = retCount;
                if (document.getElementById('totalAlertas')) document.getElementById('totalAlertas').innerText = alertCount;
                if (document.getElementById('totalKYC')) document.getElementById('totalKYC').innerText = kycCount + ' clientes';
            },

            async generarXML() {
                if (!this.currentData.depositos.length && !this.currentData.retiros.length) return alert("Carga operaciones primero");
                // Uses this.currentData (filtered by selected month)
                // XML Logic reused/simplified
                const rfc = this.config.rfc;
                const periodo = document.getElementById('periodoSelector').value; // 202501
                if (!periodo) return alert("Selecciona periodo");

                const avsDeps = this.currentData.depositos.filter(o => o.umaEq >= this.config.aviso);
                const avsRets = this.currentData.retiros.filter(o => o.umaEq >= this.config.aviso);

                if (avsDeps.length) this.downloadXML(avsDeps, 'DEPOSITOS', periodo);
                if (avsRets.length) this.downloadXML(avsRets, 'RETIROS', periodo);

                if (!avsDeps.length && !avsRets.length) alert("Ninguna operaci√≥n supera el umbral de aviso (" + this.config.aviso + " UMA)");
            },

            // --- FILTERING LOGIC ---
            currentData: { depositos: [], retiros: [] }, // Store loaded data

            filterOperations(filterType) {
                // Store active card filter
                this.activeCardFilter = filterType;

                // If resetting ('all'), also clear visual inputs logic if triggered by 'Limpiar Filtros'
                // Usually 'all' is triggered by load or reset button.
                if (filterType === 'all') {
                    document.getElementById('searchOps').value = '';
                    document.getElementById('filterStatus').value = '';
                }

                this.applyFilters();
            },

            applyFilters() {
                try {
                    const filterType = this.activeCardFilter || 'all';

                    // Safe Config
                    const cfgAviso = (this.config && this.config.aviso) ? this.config.aviso : 645;
                    const cfgMonitoreo = (this.config && this.config.monitoreo) ? this.config.monitoreo : 325;

                    // Source
                    const sourceDeps = this.currentData.depositos || [];
                    const sourceRets = this.currentData.retiros || [];

                    const searchInput = document.getElementById('searchOps');
                    const searchText = searchInput ? searchInput.value.toLowerCase().trim() : '';

                    const statusVal = document.getElementById('filterStatus') ? document.getElementById('filterStatus').value : '';

                    // Filter Logic
                    const filterFn = (list) => {
                        return list.filter(r => {
                            if (!r) return false;
                            // Status
                            const val = r.umaEq || 0;
                            let status = 'normal';
                            if (val >= cfgAviso) status = 'aviso';
                            else if (val >= cfgMonitoreo) status = 'monitoreo';

                            // Logic Filters
                            if (searchText) {
                                const txt = ((r.username || '') + (r.playercode || '') + (r.rfc || '')).toLowerCase();
                                if (!txt.includes(searchText)) return false;
                            }

                            if (statusVal && status !== statusVal) return false;

                            // Card Filters
                            if (filterType === 'aviso' && val < cfgAviso) return false;
                            if (filterType === 'monitoreo' && (val < cfgMonitoreo || val >= cfgAviso)) return false;

                            return true;
                        });
                    };

                    let visibleDeps = [];
                    let visibleRets = [];

                    if (filterType !== 'retiro') visibleDeps = filterFn(sourceDeps);
                    if (filterType !== 'deposito') visibleRets = filterFn(sourceRets);

                    // Show Sections logic
                    const tDep = document.getElementById('tableDepositos');
                    const tRet = document.getElementById('tableRetiros');
                    if (tDep) {
                        const wrap = tDep.closest('.table-container');
                        if (wrap) {
                            const show = visibleDeps.length > 0 || filterType === 'all' || filterType === 'deposito';
                            wrap.style.display = show ? 'block' : 'none';
                            if (wrap.previousElementSibling) wrap.previousElementSibling.style.display = show ? 'block' : 'none';
                        }
                    }
                    if (tRet) {
                        const wrap = tRet.closest('.table-container');
                        if (wrap) {
                            const show = visibleRets.length > 0 || filterType === 'all' || filterType === 'retiro';
                            wrap.style.display = show ? 'block' : 'none';
                            if (wrap.previousElementSibling) wrap.previousElementSibling.style.display = show ? 'block' : 'none';
                        }
                    }

                    // CORRECTED ARGUMENT ORDER: id, data, paginationId
                    ui.renderTable('tableDepositos', visibleDeps, 'pagDepositos');
                    ui.renderTable('tableRetiros', visibleRets, 'pagRetiros');

                    // Store for Export
                    this.lastFilteredResults = { depositos: visibleDeps, retiros: visibleRets };

                    // Highlight Active Card
                    document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active-filter'));
                    const activeCard = document.querySelector(`.card-${filterType}s`);
                    if (activeCard) activeCard.classList.add('active-filter');

                } catch (e) {
                    console.error('Filter Error', e);
                }
            },

            async exportToExcel() {
                const data = this.lastFilteredResults || { depositos: [], retiros: [] };
                if (!data.depositos.length && !data.retiros.length) return alert("No hay datos para exportar con los filtros actuales.");

                const wb = XLSX.utils.book_new();

                const formatData = (list) => list.map(item => ({
                    Usuario: item.username,
                    Nombre: `${item.firstname} ${item.lastname}`,
                    RFC: item.rfc,
                    Monto: item.monto,
                    'Veces Umbral': (item.umaEq / this.config.monitoreo).toFixed(2) + 'x',
                    UMA: item.umaEq.toFixed(2),
                    Fecha: item.fechaProceso ? new Date(item.fechaProceso).toLocaleDateString() : '',
                    Email: item.email,
                    Telefono: item.phone,
                    'Entidad Federativa': item.estadoDir || 'Desconocido',
                    Estado: item.umaEq >= this.config.aviso ? 'AVISO' : (item.umaEq >= this.config.monitoreo ? 'MONITOREO' : 'NORMAL')
                }));

                if (data.depositos.length) {
                    const ws = XLSX.utils.json_to_sheet(formatData(data.depositos));
                    XLSX.utils.book_append_sheet(wb, ws, "Depositos_Filtrados");
                }
                if (data.retiros.length) {
                    const ws = XLSX.utils.json_to_sheet(formatData(data.retiros));
                    XLSX.utils.book_append_sheet(wb, ws, "Retiros_Filtrados");
                }

                XLSX.writeFile(wb, `Reporte_PLD_Operaciones_${new Date().toISOString().slice(0, 10)}.xlsx`);
            },

            showSingleTable(tableId, list) {
                // Deprecated by applyFilters logic, but kept for ref safety or removed?
                // Removal safe as applyFilters handles partial rendering.
            },
            async downloadXML(ops, tipo, periodo) {
                if (!auth.currentUser) return alert('Debes iniciar sesi√≥n');

                ui.toggleLoading(true);
                ui.showToast("Solicitando generaci√≥n de XML al servidor...");

                try {
                    // Call Cloud Function
                    const generateFn = fFunctions.httpsCallable('generateXMLBatch');

                    // We don't need to send 'ops' array, the server query them from Firestore
                    const result = await generateFn({
                        periodoId: parseInt(periodo), // 202501
                        tipo: tipo.toUpperCase() // 'DEPOSITO' or 'RETIRO' (or mapped to 'AVISO')
                    });

                    if (result.data.success) {
                        ui.showToast("‚úÖ XML Generado. Iniciando descarga...");
                        if (result.data.url) {
                            const a = document.createElement('a');
                            a.href = result.data.url;
                            a.download = `Aviso_${periodo}.xml`; // Name might be set by header
                            a.target = '_blank';
                            a.click();
                        }
                        this.logAction('GENERAR_XML', `Cloud Generation Success: ${periodo}`);
                    } else {
                        throw new Error(result.data.message || "Error desconocido");
                    }
                } catch (e) {
                    console.error(e);
                    alert("Error generando XML: " + e.message);
                } finally {
                    ui.toggleLoading(false);
                }
            },

            formatDateXML(rawDate) {
                // Tries to parse whatever date format comes in and output YYYYMMDD
                if (!rawDate) return '19000101';
                try {
                    const d = new Date(rawDate);
                    if (isNaN(d.getTime())) return '19000101';
                    return d.toISOString().slice(0, 10).replace(/-/g, '');
                } catch (e) { return '19000101'; }
            },

            escapeXML(str) {
                if (!str) return '';
                return str.replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&apos;');
            },

            async cargarReportes() {
                const reps = await dbService.getAll('reports');
                reps.sort((a, b) => b.id - a.id);
                const tbody = document.querySelector('#tableReportes tbody');
                tbody.innerHTML = reps.map(r => `<tr><td>${new Date(r.fecha).toLocaleString()}</td><td>${r.tipo}</td><td>${r.archivo}</td><td>-</td></tr>`).join('');
            },

            // === AUDIT LOG SYSTEM ===
            async logAction(action, details, user = 'Oficial de Cumplimiento') {
                const log = {
                    id: Date.now(),
                    fecha: new Date().toISOString(),
                    user: user,
                    action: action,
                    details: details
                };
                await dbService.addItems('audit_logs', [log]);
                console.log('AUDIT:', action);
                // If viewing audit tab, refresh it
                if (document.getElementById('tab-audit').classList.contains('active')) {
                    this.cargarAudit();
                }
            },

            async cargarAudit() {
                const logs = await dbService.getAll('audit_logs');
                logs.sort((a, b) => b.id - a.id);
                ui.renderAudit(logs);
            }
        };

        // === UTILS ===
        const Utils = {
            removeAccents(str) {
                return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            },

            filterInconvenientWords(rfc) {
                const badWords = ['BUEI', 'BUEY', 'CACA', 'CACO', 'CAGA', 'CAGO', 'CAKA', 'CAKO', 'COGE', 'COJA', 'COJE', 'COJI', 'COJO', 'CULO', 'FETO', 'GUEY', 'JOTO', 'KACA', 'KACO', 'KAGA', 'KAGO', 'KOGE', 'KOJO', 'KAKA', 'KULO', 'MAME', 'MAMO', 'MEAR', 'MEAS', 'MEON', 'MIAR', 'MION', 'MOCO', 'MULA', 'PEDA', 'PEDO', 'PENE', 'PUTA', 'PUTO', 'QULO', 'RATA', 'RUIN'];
                return badWords.includes(rfc) ? rfc.substring(0, 3) + 'X' : rfc;
            },

            isVowel(char) {
                return /^[AEIOU]$/i.test(char);
            },

            // Full Official Algorithm for Homoclave
            calculateHomoclave(fullName) {
                const map = {
                    ' ': '00', '0': '00', '1': '01', '2': '02', '3': '03', '4': '04', '5': '05', '6': '06', '7': '07', '8': '08', '9': '09',
                    '&': '10', 'A': '11', 'B': '12', 'C': '13', 'D': '14', 'E': '15', 'F': '16', 'G': '17', 'H': '18', 'I': '19', 'J': '21',
                    'K': '22', 'L': '23', 'M': '24', 'N': '25', 'O': '26', 'P': '27', 'Q': '28', 'R': '29', 'S': '32', 'T': '33', 'U': '34',
                    'V': '35', 'W': '36', 'X': '37', 'Y': '38', 'Z': '39', '√ë': '40'
                };

                let numStr = '0'; // Prepend 0
                for (let i = 0; i < fullName.length; i++) {
                    const c = fullName.charAt(i);
                    numStr += map[c] || '00';
                }

                let sum = 0;
                for (let i = 0; i < numStr.length - 1; i += 2) { // Read pairs?? No, logic is pairwise sum
                    // Standard algorithm iterates pairs of the mapped *values* concatenation
                    // Actually, mapped values are concatenated string. Then iterate.
                }

                // Simplified Standard Homoclave Logic (approximate for Client-Side without heavy lookup)
                // Use Name Hash -> Base34
                // REF: http://fiscalistas.mx/2012/10/algoritmo-para-generar-el-rfc-con-homoclave-para-personas-fisicas-y-morales/
                // Correct logic:
                // 1. Translate name to huge number string using map.
                // 2. Sum couples: (N[i]*10 + N[i+1]) * N[i+1]
                // 3. Last 3 digits of sum used.

                // Let's implement robustly:
                let scores = [];
                for (let i = 0; i < fullName.length; i++) {
                    scores.push(map[fullName[i]] || '00');
                }
                let strScores = '0' + scores.join(''); // Prepend 0

                let sumH = 0;
                for (let i = 0; i < scores.length; i++) {
                    // i refers to pair position in strScores which is length scores.length+1
                    // Formula: (Parse(str[i]str[i+1])*10 + Parse(str[i+1])) is wrong.
                    // Correct: (Int(Str[i] + Str[i+1])) * Int(Str[i+1])
                    const s1 = parseInt(strScores.substring(i, i + 2));
                    const s2 = parseInt(strScores.substring(i + 1, i + 2));
                    sumH += s1 * s2;
                }

                const last3 = sumH % 1000;
                const quo = Math.floor(last3 / 34);
                const res = last3 % 34;

                const homoclaveChars = "123456789ABCDEFGHIJKLMNPQRSTUVWXYZ"; // 34 chars (O excluded? No, standard base 34)
                // Official SAT table for result: 0->1, 1->2... 33->Z.
                // Let's use array.

                return homoclaveChars[quo] + homoclaveChars[res];
            },

            calculateCheckDigit(rfc12) {
                const map = {
                    '0': 0, '1': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9,
                    'A': 10, 'B': 11, 'C': 12, 'D': 13, 'E': 14, 'F': 15, 'G': 16, 'H': 17, 'I': 18, 'J': 19,
                    'K': 20, 'L': 21, 'M': 22, 'N': 23, '&': 24, 'O': 25, 'P': 26, 'Q': 27, 'R': 28, 'S': 29,
                    'T': 30, 'U': 31, 'V': 32, 'W': 33, 'X': 34, 'Y': 35, 'Z': 36, ' ': 37, '√ë': 38
                };

                let sum = 0;
                for (let i = 0; i < 12; i++) {
                    const c = rfc12.charAt(i);
                    const val = map[c] || 0;
                    sum += val * (13 - i); // Weight 13, 12... 2
                }

                const rem = sum % 11;
                if (rem === 0) return '0';
                if (rem > 0) {
                    const diff = 11 - rem;
                    if (diff === 10) return 'A';
                    return diff.toString();
                }
                return '0'; // fallback
            },

            calcularRFC(nombre, paterno, materno, fechaNac) { // fechaNac: Javascript Date object or "YYYY-MM-DD" string
                try {
                    // 1. Clean inputs
                    let n = this.removeAccents(nombre.trim().toUpperCase());
                    let p = this.removeAccents(paterno.trim().toUpperCase());
                    let m = materno ? this.removeAccents(materno.trim().toUpperCase()) : '';

                    // Remove common particles
                    const particles = ['DE ', 'DEL ', 'LA ', 'LOS ', 'LAS ', 'Y ', 'MC ', 'MAC ', 'VON ', 'VAN '];
                    particles.forEach(part => {
                        // Logic simplification: Replace ALL occurrences or just startsWith? 
                        // Standard is usually treating name as tokens.
                        // For safety, let's just strip leading.
                        if (n.startsWith(part)) n = n.substring(part.length);
                        if (p.startsWith(part)) p = p.substring(part.length);
                        if (m.startsWith(part)) m = m.substring(part.length);
                    });

                    // 2. Generate First 4 Letters
                    let rfc = '';
                    rfc += p.charAt(0);
                    let vowelFound = false;
                    for (let i = 1; i < p.length; i++) { if (this.isVowel(p.charAt(i))) { rfc += p.charAt(i); vowelFound = true; break; } }
                    if (!vowelFound) rfc += 'X';
                    rfc += m ? m.charAt(0) : 'X';
                    rfc += n.charAt(0);
                    rfc = this.filterInconvenientWords(rfc);

                    // 3. Date YYMMDD
                    let d = new Date(fechaNac);
                    if (isNaN(d.getTime())) return "XAXX010101000";
                    const yy = d.getFullYear().toString().slice(-2);
                    const mm = (d.getMonth() + 1).toString().padStart(2, '0');
                    const dd = d.getDate().toString().padStart(2, '0');
                    rfc += yy + mm + dd;

                    // 4. Calculate Homoclave (Real)
                    // Full Name for Algo: Paterno + " " + Materno + " " + Nombre
                    const fullNameForAlgo = `${p} ${m} ${n}`;
                    const homoclity = this.calculateHomoclave(fullNameForAlgo);
                    rfc += homoclity;

                    // 5. Calculate Check Digit
                    const verifier = this.calculateCheckDigit(rfc);
                    rfc += verifier;

                    return rfc;
                } catch (e) {
                    console.error("RFC Algo Error", e);
                    return "XAXX010101000";
                }
            },

            getStateFromCP(cp) {
                if (!cp || cp.length < 2) return 'Desconocido';
                const prefix = parseInt(cp.substring(0, 2));

                if (prefix >= 1 && prefix <= 16) return 'Ciudad de M√©xico';
                if (prefix >= 20 && prefix <= 20) return 'Aguascalientes';
                if (prefix >= 21 && prefix <= 22) return 'Baja California';
                if (prefix >= 23 && prefix <= 23) return 'Baja California Sur';
                if (prefix >= 24 && prefix <= 24) return 'Campeche';
                if (prefix >= 25 && prefix <= 27) return 'Coahuila';
                if (prefix >= 28 && prefix <= 28) return 'Colima';
                if (prefix >= 29 && prefix <= 30) return 'Chiapas';
                if (prefix >= 31 && prefix <= 33) return 'Chihuahua';
                if (prefix >= 34 && prefix <= 35) return 'Durango';
                if (prefix >= 36 && prefix <= 38) return 'Guanajuato';
                if (prefix >= 39 && prefix <= 41) return 'Guerrero';
                if (prefix >= 42 && prefix <= 43) return 'Hidalgo';
                if (prefix >= 44 && prefix <= 49) return 'Jalisco';
                if (prefix >= 50 && prefix <= 57) return 'Estado de M√©xico';
                if (prefix >= 58 && prefix <= 59) return 'Michoac√°n';
                if (prefix >= 60 && prefix <= 62) return 'Morelos';
                if (prefix >= 63 && prefix <= 63) return 'Nayarit';
                if (prefix >= 64 && prefix <= 67) return 'Nuevo Le√≥n';
                if (prefix >= 68 && prefix <= 71) return 'Oaxaca';
                if (prefix >= 72 && prefix <= 75) return 'Puebla';
                if (prefix >= 76 && prefix <= 76) return 'Quer√©taro';
                if (prefix >= 77 && prefix <= 77) return 'Quintana Roo';
                if (prefix >= 78 && prefix <= 79) return 'San Luis Potos√≠';
                if (prefix >= 80 && prefix <= 82) return 'Sinaloa';
                if (prefix >= 83 && prefix <= 85) return 'Sonora';
                if (prefix >= 98 && prefix <= 99) return 'Zacatecas';

                return 'Otro/Desconocido';
            },

            getRiskState(nombreEstado) {
                if (!nombreEstado) return 'Desconocido';
                const s = this.removeAccents(nombreEstado.toLowerCase().trim());

                // HIGH RISK (Border, Drug Trafficking Hubs, Financial Districts, Major Tourism)
                // Baja California, Sonora, Chihuahua, Coahuila, Nuevo Leon, Tamaulipas (Border)
                // Sinaloa, Durango, Michoacan, Guerrero, Jalisco, Colima (Incidence)
                // CDMX (Financial), Quintana Roo (Tourism/Laundering)
                const high = ['baja california', 'sonora', 'chihuahua', 'coahuila', 'nuevo leon', 'tamaulipas',
                    'sinaloa', 'durango', 'michoacan', 'guerrero', 'jalisco', 'colima',
                    'ciudad de mexico', 'cdmx', 'quintana roo'];

                // MEDIUM RISK (Industrial, Central Hubs, Ports)
                // Guanajuato, Edomex, Morelos, Veracruz, Puebla, BCS, Nayarit, Zacatecas, San Luis Potosi
                const medium = ['guanajuato', 'estado de mexico', 'mexico', 'morelos', 'veracruz', 'puebla',
                    'baja california sur', 'nayarit', 'zacatecas', 'san luis potosi'];

                if (high.some(h => s.includes(h))) return 'Alto';
                if (medium.some(m => s.includes(m))) return 'Medio';

                return 'Bajo'; // Default Low for others (Tlaxcala, Hidalgo, Queretaro, South, etc)
            },

            getStateISO(nombreEstado) {
                if (!nombreEstado) return '';
                const s = this.removeAccents(nombreEstado.toLowerCase().trim());
                const map = {
                    'aguascalientes': 'MX-AGU', 'baja california': 'MX-BCN', 'baja california sur': 'MX-BCS',
                    'campeche': 'MX-CAM', 'chiapas': 'MX-CHP', 'chihuahua': 'MX-CHH', 'ciudad de mexico': 'MX-CMX', 'cdmx': 'MX-CMX',
                    'coahuila': 'MX-COA', 'colima': 'MX-COL', 'durango': 'MX-DUR', 'guanajuato': 'MX-GUA',
                    'guerrero': 'MX-GRO', 'hidalgo': 'MX-HID', 'jalisco': 'MX-JAL', 'mexico': 'MX-MEX', 'estado de mexico': 'MX-MEX',
                    'michoacan': 'MX-MIC', 'morelos': 'MX-MOR', 'nayarit': 'MX-NAY', 'nuevo leon': 'MX-NLE',
                    'oaxaca': 'MX-OAX', 'puebla': 'MX-PUE', 'queretaro': 'MX-QUE', 'quintana roo': 'MX-ROO',
                    'san luis potosi': 'MX-SLP', 'sinaloa': 'MX-SIN', 'sonora': 'MX-SON', 'tabasco': 'MX-TAB',
                    'tamaulipas': 'MX-TAM', 'tlaxcala': 'MX-TLA', 'veracruz': 'MX-VER', 'yucatan': 'MX-YUC', 'zacatecas': 'MX-ZAC'
                };
                // Simple partial match check if exact match fails
                if (map[s]) return map[s];
                for (let k in map) { if (s.includes(k)) return map[k]; }
                return '';
            }
        };

        // === DB SERVICE ===
        // === AUTH SERVICE (FIREBASE) ===
        const auth = {
            currentUser: null,

            init() {
                // Listen to Auth State
                fAuth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log('üë§ User logged in:', user.email);
                        // Get IdTokenResult for claims (role, tenantId)
                        const token = await user.getIdTokenResult();
                        this.currentUser = {
                            email: user.email,
                            role: token.claims.role || 'viewer',
                            tenantId: token.claims.tenantId,
                            uid: user.uid
                        };

                        dbService.currentTenantId = this.currentUser.tenantId;

                        // UI Updates
                        document.getElementById('loginOverlay').classList.add('hidden');
                        document.getElementById('currentUserDisplay').textContent = `${user.email} (${this.currentUser.role})`;

                        // Show Admin Panel Logic
                        if (this.currentUser.role === 'admin' || this.currentUser.role === 'super_admin') {
                            document.getElementById('adminPanel').style.display = 'block';
                        } else {
                            document.getElementById('adminPanel').style.display = 'none';
                        }

                        // Establish Listeners for this tenant
                        app.initListeners();

                    } else {
                        console.log('üë§ User logged out');
                        this.currentUser = null;
                        document.getElementById('loginOverlay').classList.remove('hidden');
                    }
                });
            },

            async login(email, password) {
                try {
                    await fAuth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    console.error("Login Failed", error);
                    throw new Error(error.message); // UI catches this
                }
            },

            async logout() {
                await fAuth.signOut();
                window.location.reload();
            },

            async register(email, password) {
                // In SaaS, registration is usually via Admin Invite or separate page. 
                // We'll throw error or redirect.
                throw new Error("El registro p√∫blico est√° desactivado. Contacta a tu administrador.");
            },

            async recoverPassword(email) {
                await fAuth.sendPasswordResetEmail(email);
                alert('Correo de recuperaci√≥n enviado a ' + email);
            }
        };

        // === UI HANDLERS ===
        const ui = {
            chartInstance: null,

            toggleLoading(show) { document.getElementById('loadingProcess').classList.toggle('active', show); },

            showToast(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg; t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            },

            updateTabs(id) { document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active')); document.getElementById('tab-' + id).classList.add('active'); },

            getConfigFromDOM() {
                return {
                    rfc: document.getElementById('rfcSujetoObligado').value,
                    razon: document.getElementById('razonSocial').value,
                    year: document.getElementById('yearSelect').value,
                    uma: parseFloat(document.getElementById('umaValue').value),
                    aviso: parseFloat(document.getElementById('thresholdAviso').value),
                    monitoreo: parseFloat(document.getElementById('thresholdMonitoreo').value)
                };
            },
            fillConfig(cfg) {
                if (cfg.rfc) document.getElementById('rfcSujetoObligado').value = cfg.rfc;
                if (cfg.uma) document.getElementById('umaValue').value = cfg.uma;
                if (cfg.aviso) document.getElementById('thresholdAviso').value = cfg.aviso;
                if (cfg.monitoreo) document.getElementById('thresholdMonitoreo').value = cfg.monitoreo;
            },

            renderOperaciones(data) {
                // Update stats
                document.getElementById('opTotalDeps').textContent = data.depositos.length;
                document.getElementById('opTotalRets').textContent = data.retiros.length;
                const avisos = data.depositos.filter(d => d.umaEq >= app.config.aviso).length + data.retiros.filter(r => r.umaEq >= app.config.aviso).length;
                document.getElementById('opTotalAvisos').textContent = avisos;

                this.renderTable('tableDepositos', data.depositos, 'pagDepositos');
                this.renderTable('tableRetiros', data.retiros, 'pagRetiros');
                this.renderDashboard(data);
            },

            renderDashboard(data) {
                const ctx = document.getElementById('dashboardChart').getContext('2d');
                if (this.chartInstance) this.chartInstance.destroy();

                const depTotal = data.depositos.length;
                const retTotal = data.retiros.length;
                const depAmo = data.depositos.reduce((a, b) => a + b.monto, 0);
                const retAmo = data.retiros.reduce((a, b) => a + b.monto, 0);

                this.chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Dep√≥sitos', 'Retiros'],
                        datasets: [
                            {
                                label: 'Cantidad Operaciones',
                                data: [depTotal, retTotal],
                                backgroundColor: ['#3498db', '#2ecc71'],
                                yAxisID: 'y',
                            },
                            {
                                label: 'Monto Total (MXN)',
                                data: [depAmo, retAmo],
                                backgroundColor: ['#2980b9', '#27ae60'],
                                type: 'line',
                                yAxisID: 'y1',
                                borderColor: '#e74c3c',
                                borderWidth: 2,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Cantidad' } },
                            y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Monto ($)' } }
                        }
                    }
                });
            },

            renderAudit(logs) {
                const tbody = document.querySelector('#tableAudit tbody');
                if (!logs.length) { tbody.innerHTML = '<tr><td colspan="4">Sin registros de auditor√≠a</td></tr>'; return; }

                tbody.innerHTML = logs.slice(0, 100).map(l => `<tr>
                    <td>${new Date(l.fecha).toLocaleString()}</td>
                    <td><span class="badge-status normal" style="background:${l.user.includes('System') ? '#f1f5f9' : '#e0f2fe'}; color:${l.user.includes('System') ? '#64748b' : '#0369a1'}">${l.user}</span></td>
                    <td><strong>${l.action}</strong></td>
                    <td style="font-family:monospace; font-size:0.85em; color:var(--text-muted);">${l.details}</td>
                </tr>`).join('');
            },

            renderTable(id, data, paginationId = null, page = 1) {
                const tbody = document.querySelector(`#${id} tbody`);
                if (!tbody) return;

                if (!data || !data.length) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px; color:#94a3b8;">Sin operaciones para mostrar.</td></tr>';
                    if (paginationId && document.getElementById(paginationId)) document.getElementById(paginationId).innerHTML = '';
                    return;
                }

                // Paging
                const pageSize = 50;
                const totalPages = Math.ceil(data.length / pageSize);
                if (page < 1) page = 1;
                if (page > totalPages) page = totalPages;

                const start = (page - 1) * pageSize;
                const end = start + pageSize;
                const slice = data.slice(start, end);

                tbody.innerHTML = slice.map(r => {
                    try {
                        const val = r.umaEq || 0;

                        // Config Safety - We need to be careful with closures, but for now fixed vars or safe access
                        const cfgAviso = 645;
                        const cfgMonitoreo = 325;

                        let badgeClass = 'normal';
                        let badgeText = 'Normal';

                        if (val >= cfgAviso) {
                            badgeClass = 'aviso';
                            badgeText = 'AVISO';
                        } else if (val >= cfgMonitoreo) {
                            badgeClass = 'monitoreo';
                            badgeText = 'MONITOREO';
                        }

                        // Calculation for "Veces Umbral" (Identification)
                        const veces = (val / cfgMonitoreo);
                        const vecesUmbral = isFinite(veces) ? veces.toFixed(2) + 'x' : '0.00x';

                        // Format Currency
                        const montoStr = (r.monto || 0).toLocaleString('es-MX', { minimumFractionDigits: 2 });

                        return `<tr>
                            <td style="font-weight:bold;">${r.username || ''}</td>
                            <td>${r.firstname || ''} ${r.lastname || ''}</td>
                            <td>$${montoStr}</td>
                            <td>$${montoStr}</td>
                            <td style="text-align:center;">${vecesUmbral}</td>
                            <td>${val.toFixed(2)}</td>
                            <td style="font-size:0.9em;">${r.email || '-'}</td>
                            <td style="font-size:0.9em;">${r.phone || '-'}</td>
                            <td style="text-align:center;"><span class="badge-status ${badgeClass}">${badgeText}</span></td>
                        </tr>`;
                    } catch (e) {
                        return '';
                    }
                }).join('');

                // Render Pagination Controls
                if (paginationId && document.getElementById(paginationId)) {
                    const pagContainer = document.getElementById(paginationId);
                    if (totalPages > 1) {
                        // Careful with quoting
                        const listName = id === 'tableDepositos' ? 'depositos' : 'retiros';
                        pagContainer.innerHTML = `
                            <button class="page-btn" ${page === 1 ? 'disabled' : ''} onclick="ui.renderTable('${id}', app.currentData.${listName}, '${paginationId}', ${page - 1})">‚óÄ</button>
                            <span style="padding: 0 10px; font-size:0.9em">P√°g ${page} de ${totalPages}</span>
                            <button class="page-btn" ${page === totalPages ? 'disabled' : ''} onclick="ui.renderTable('${id}', app.currentData.${listName}, '${paginationId}', ${page + 1})">‚ñ∂</button>
                        `;
                    } else {
                        pagContainer.innerHTML = '';
                    }
                }
            },

            renderKYC(clientes, paginationId = 'pagKYC', page = 1) {
                const tbody = document.querySelector('#tableKYC tbody');
                // Store in app for pagination access
                app.currentData.kyc = clientes;

                if (!clientes.length) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">No hay datos en el Padr√≥n. Cargue operaciones para poblar.</td></tr>';
                    if (document.getElementById(paginationId)) document.getElementById(paginationId).innerHTML = '';
                    return;
                }

                // Paging
                const pageSize = 50;
                const totalPages = Math.ceil(clientes.length / pageSize);
                if (page < 1) page = 1;
                if (page > totalPages) page = totalPages;

                const start = (page - 1) * pageSize;
                const end = start + pageSize;
                const slice = clientes.slice(start, end);

                tbody.innerHTML = slice.map(c => {
                    // AGE LOGIC: Prefer explicit 'edad' from Excel, else Calc from DOB
                    let edad = c.edad || '-';
                    if ((!edad || edad === 0 || edad === '-') && c.dob) {
                        const dob = new Date(c.dob);
                        if (!isNaN(dob.getTime())) {
                            const diff = Date.now() - dob.getTime();
                            edad = Math.floor(diff / (1000 * 60 * 60 * 24 * 365.25));
                        }
                    }

                    // SEX LOGIC: Prefer explicit 'sexoRaw' (Map M->H, F->M), else infer from CURP
                    let sexo = '?';
                    if (c.sexoRaw) {
                        if (c.sexoRaw === 'M' || c.sexoRaw === 'MALE') sexo = 'H';
                        else if (c.sexoRaw === 'F' || c.sexoRaw === 'FEMALE') sexo = 'M';
                        else sexo = c.sexoRaw.charAt(0);
                    } else if (c.curp && c.curp.length >= 11) {
                        sexo = c.curp.charAt(10).toUpperCase();
                    }

                    // Infer State from CP
                    const estado = c.estado || Utils.getStateFromCP(c.cp);

                    // Attach for Dashboard
                    c.finalEdad = edad;
                    c.finalSexo = sexo;
                    c.finalEstado = estado;

                    return `<tr onclick="ui.openClientModal('${c.playercode}')" style="cursor:pointer" title="Ver Detalles">
                    <td><strong>${c.playercode}</strong></td>
                    <td>${c.nombre} ${c.apellido}<br><span style="font-size:0.85em; color:var(--primary)">${c.email}</span></td>
                    <td><span class="badge-status normal">${estado}</span></td>
                    <td>${edad} a√±os / <strong>${sexo}</strong></td>
                    <td style="font-size:0.85em; max-width:150px; overflow:hidden; text-overflow:ellipsis;">${c.ocupacion || 'NO REGISTRADO'}</td>
                    <td>
                        <div style="font-size:0.85em">RFC: ${c.rfc}</div>
                        <div style="font-size:0.85em; color:#64748b">CURP: ${c.curp}</div>
                    </td>
                    <td style="font-size:0.85em">
                        ${c.direccion || ''} ${c.cp ? 'CP ' + c.cp : ''}
                    </td>
                </tr>`;
                }).join('');

                // Render Pagination Controls
                if (paginationId && document.getElementById(paginationId)) {
                    const pagContainer = document.getElementById(paginationId);
                    if (totalPages > 1) {
                        pagContainer.innerHTML = `
                            <button class="page-btn" ${page === 1 ? 'disabled' : ''} onclick="ui.renderKYC(app.currentData.kyc, '${paginationId}', ${page - 1})">‚óÄ</button>
                            <span style="padding: 0 10px; font-size:0.9em;">P√°g ${page} de ${totalPages}</span>
                            <button class="page-btn" ${page === totalPages ? 'disabled' : ''} onclick="ui.renderKYC(app.currentData.kyc, '${paginationId}', ${page + 1})">‚ñ∂</button>
                        `;
                    } else {
                        pagContainer.innerHTML = '';
                    }
                }
            },

            renderKYCDashboard(clientes) {
                // 1. Process Data
                const stateMap = {};
                const sexMap = { 'H': 0, 'M': 0, '?': 0 };
                const ageMap = { '18-25': 0, '26-35': 0, '36-45': 0, '46-60': 0, '60+': 0, 'N/A': 0 };

                clientes.forEach(c => {
                    // State
                    const st = c.finalEstado || c.estado || Utils.getStateFromCP(c.cp) || 'Desconocido';
                    stateMap[st] = (stateMap[st] || 0) + 1;

                    // Sex
                    let s = c.finalSexo || '?';
                    if (s === '?') {
                        if (c.sexoRaw) {
                            if (c.sexoRaw === 'M' || c.sexoRaw === 'MALE') s = 'H';
                            else if (c.sexoRaw === 'F' || c.sexoRaw === 'FEMALE') s = 'M';
                        } else if (c.curp && c.curp.length >= 11) {
                            s = c.curp.charAt(10).toUpperCase();
                        }
                    }
                    if (!sexMap[s] && sexMap[s] !== 0) s = '?'; // Safety
                    sexMap[s]++;

                    // Age
                    let ageGroup = 'N/A';
                    let age = c.finalEdad;

                    // Fallback calc if finalEdad missing
                    if ((!age || age === '-') && c.dob) {
                        const d = new Date(c.dob);
                        if (!isNaN(d.getTime())) {
                            age = Math.floor((Date.now() - d.getTime()) / (1000 * 60 * 60 * 24 * 365.25));
                        }
                    }

                    if (typeof age === 'number') {
                        if (age >= 18 && age <= 25) ageGroup = '18-25';
                        else if (age >= 26 && age <= 35) ageGroup = '26-35';
                        else if (age >= 36 && age <= 45) ageGroup = '36-45';
                        else if (age >= 46 && age <= 60) ageGroup = '46-60';
                        else if (age > 60) ageGroup = '60+';
                    }
                    ageMap[ageGroup]++;
                });

                // --- RESTORED: RENDER TOP ROW DEMOGRAPHIC CHARTS ---

                // 2. Render State Chart (Horizontal Bar)
                const ctxState = document.getElementById('chartStates');
                if (window.chartStateInst) window.chartStateInst.destroy();
                const sortedStates = Object.entries(stateMap).sort((a, b) => b[1] - a[1]).slice(0, 10);
                window.chartStateInst = new Chart(ctxState, {
                    type: 'bar',
                    data: {
                        labels: sortedStates.map(x => x[0]),
                        datasets: [{
                            label: 'Usuarios',
                            data: sortedStates.map(x => x[1]),
                            backgroundColor: '#3b82f6',
                            borderRadius: 4
                        }]
                    },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                // 3. Render Sex Chart (Pie)
                const ctxSex = document.getElementById('chartSex');
                if (window.chartSexInst) window.chartSexInst.destroy();
                window.chartSexInst = new Chart(ctxSex, {
                    type: 'doughnut',
                    data: {
                        labels: ['Hombres', 'Mujeres', 'Desc'],
                        datasets: [{
                            data: [sexMap['H'], sexMap['M'], sexMap['?']],
                            backgroundColor: ['#3b82f6', '#ec4899', '#cbd5e1']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // 4. Render Age Chart (Bar)
                const ctxAge = document.getElementById('chartAges');
                if (window.chartAgeInst) window.chartAgeInst.destroy();
                window.chartAgeInst = new Chart(ctxAge, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(ageMap),
                        datasets: [{
                            label: 'Usuarios por Edad',
                            data: Object.values(ageMap),
                            backgroundColor: '#10b981',
                            borderRadius: 4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                // --- END RESTORED ---

                // RISK CALCULATION
                const riskMap = { 'Alto': 0, 'Medio': 0, 'Bajo': 0, 'Desconocido': 0 };
                const highRiskStates = {};
                const medRiskStates = {};
                const lowRiskStates = {};
                const mapDataArray = [['Estado', 'Usuarios', { role: 'tooltip', p: { html: true } }]];

                clientes.forEach(c => {
                    // Normalize State name for matching
                    const stRaw = c.finalEstado || c.estado || Utils.getStateFromCP(c.cp) || 'Desconocido';
                    const riskLevel = Utils.getRiskState(stRaw);

                    riskMap[riskLevel]++;

                    if (riskLevel === 'Alto') highRiskStates[stRaw] = (highRiskStates[stRaw] || 0) + 1;
                    else if (riskLevel === 'Medio') medRiskStates[stRaw] = (medRiskStates[stRaw] || 0) + 1;
                    else lowRiskStates[stRaw] = (lowRiskStates[stRaw] || 0) + 1;
                });

                // Prepare Map Data
                const isoMap = {};
                clientes.forEach(c => {
                    const stRaw = c.finalEstado || c.estado || Utils.getStateFromCP(c.cp);
                    if (!stRaw) return;
                    const iso = Utils.getStateISO(stRaw);
                    if (iso) {
                        if (!isoMap[iso]) isoMap[iso] = { count: 0, name: stRaw, risk: Utils.getRiskState(stRaw) };
                        isoMap[iso].count++;
                    }
                });

                Object.keys(isoMap).forEach(iso => {
                    const item = isoMap[iso];
                    const pct = ((item.count / clientes.length) * 100).toFixed(1);
                    const tt = `<div style="padding:10px; min-width:150px;"><strong>${item.name}</strong><br>Usuarios: <b>${item.count}</b> (${pct}%)<br>Riesgo: <b>${item.risk}</b></div>`;
                    mapDataArray.push([{ v: iso, f: item.name }, item.count, tt]);
                });

                // RENDER RISK CHARTS
                // Global
                const ctxRiskOv = document.getElementById('chartRiskGlobal');
                if (window.chartRiskOvInst) window.chartRiskOvInst.destroy();
                window.chartRiskOvInst = new Chart(ctxRiskOv, {
                    type: 'doughnut',
                    data: {
                        labels: ['Alto', 'Medio', 'Bajo'],
                        datasets: [{ data: [riskMap['Alto'], riskMap['Medio'], riskMap['Bajo']], backgroundColor: ['#ef4444', '#f59e0b', '#10b981'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });

                // High Risk
                const ctxRiskHi = document.getElementById('chartRiskHigh');
                if (window.chartRiskHiInst) window.chartRiskHiInst.destroy();
                const sortedHigh = Object.entries(highRiskStates).sort((a, b) => b[1] - a[1]).slice(0, 5);
                window.chartRiskHiInst = new Chart(ctxRiskHi, {
                    type: 'bar',
                    data: {
                        labels: sortedHigh.map(x => x[0]),
                        datasets: [{ label: 'Usuarios', data: sortedHigh.map(x => x[1]), backgroundColor: '#ef4444', borderRadius: 4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, indexAxis: 'y' }
                });

                // Med Risk
                const ctxRiskMed = document.getElementById('chartRiskMed');
                if (window.chartRiskMedInst) window.chartRiskMedInst.destroy();
                const sortedMed = Object.entries(medRiskStates).sort((a, b) => b[1] - a[1]).slice(0, 5);
                window.chartRiskMedInst = new Chart(ctxRiskMed, {
                    type: 'bar',
                    data: {
                        labels: sortedMed.map(x => x[0]),
                        datasets: [{ label: 'Usuarios', data: sortedMed.map(x => x[1]), backgroundColor: '#f59e0b', borderRadius: 4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, indexAxis: 'y' }
                });

                // Low Risk
                const ctxRiskLo = document.getElementById('chartRiskLow');
                if (window.chartRiskLoInst) window.chartRiskLoInst.destroy();
                const sortedLow = Object.entries(lowRiskStates).sort((a, b) => b[1] - a[1]).slice(0, 5);
                window.chartRiskLoInst = new Chart(ctxRiskLo, {
                    type: 'bar',
                    data: {
                        labels: sortedLow.map(x => x[0]),
                        datasets: [{ label: 'Usuarios', data: sortedLow.map(x => x[1]), backgroundColor: '#10b981', borderRadius: 4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, indexAxis: 'y' }
                });

                // RENDER MAP
                if (typeof google !== 'undefined' && google.charts) {
                    google.charts.load('current', { 'packages': ['geochart'] });
                    google.charts.setOnLoadCallback(drawRegionsMap);
                }

                function drawRegionsMap() {
                    if (!document.getElementById('regions_div')) return;
                    const data = google.visualization.arrayToDataTable(mapDataArray);
                    const options = {
                        region: 'MX', resolution: 'provinces',
                        colorAxis: { colors: ['#10b981', '#f59e0b', '#ef4444'] },
                        backgroundColor: '#fff', datalessRegionColor: '#f8fafc', defaultColor: '#f5f5f5',
                        tooltip: { isHtml: true }
                    };
                    const chart = new google.visualization.GeoChart(document.getElementById('regions_div'));
                    chart.draw(data, options);
                }
            },

            renderMonitoreo(list, startId, endId) {
                const tbody = document.querySelector('#tableMonitoreo tbody');
                const pInfo = document.querySelector('#tab-monitoring p');
                if (pInfo && startId) pInfo.textContent = `Periodo de Acumulaci√≥n: ${startId} - ${endId} (6 Meses) | Umbral Aviso: ${app.config.aviso} UMA`;

                if (!list.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Sin usuarios activos relevantes en este periodo.</td></tr>'; return; }

                tbody.innerHTML = list.map(c => {
                    const threshold = app.config.aviso;
                    const maxAcc = Math.max(c.totalDep, c.totalRet);
                    const pct = Math.min((maxAcc / threshold) * 100, 100).toFixed(1);

                    // Determine Status
                    let statusHtml = '';
                    if (c.totalDep >= threshold) statusHtml += '<span class="badge-status aviso">Aviso Dep√≥sitos</span> ';
                    else if (c.totalDep >= app.config.monitoreo) statusHtml += '<span class="badge-status monitoreo">Monitoreo Dep</span> ';

                    if (c.totalRet >= threshold) statusHtml += '<span class="badge-status aviso">Aviso Retiros</span>';
                    else if (c.totalRet >= app.config.monitoreo) statusHtml += '<span class="badge-status monitoreo">Monitoreo Ret</span>';

                    if (!statusHtml) statusHtml = '<span class="badge-status normal">Normal</span>';

                    // Progress Bar Color
                    let barColor = 'var(--success)';
                    if (pct >= 50) barColor = 'orange'; // Warning
                    if (pct >= 80) barColor = 'var(--danger)'; // Critical

                    const depStr = c.totalDepMonto.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });
                    const retStr = c.totalRetMonto.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });

                    return `<tr>
                        <td><strong>${c.playercode}</strong><br><small>${c.firstname} ${c.lastname}</small></td>
                        <td>${depStr}<br><span style="font-size:0.8em; color:#64748b">${c.totalDep.toFixed(2)} UMA</span></td>
                        <td>${retStr}<br><span style="font-size:0.8em; color:#64748b">${c.totalRet.toFixed(2)} UMA</span></td>
                        <td style="font-weight:bold">${maxAcc.toFixed(2)} UMA</td>
                        <td style="vertical-align:middle; width:200px;">
                            <div style="display:flex; justify-content:space-between; font-size:0.75em; margin-bottom:2px;">
                                <span>${pct}%</span>
                                <span>645 UMA</span>
                            </div>
                            <div style="background:#e2e8f0; height:8px; border-radius:4px; overflow:hidden;">
                                <div style="width:${pct}%; height:100%; background:${barColor}; transition:width 0.5s;"></div>
                            </div>
                        </td>
                        <td style="text-align:center;">
                            ${statusHtml}
                        </td>
                    </tr>`;
                }).join('');
            },

            // === AUTH UI HANDLERS ===
            async handleLogin() {
                const email = document.getElementById('loginEmail').value;
                const pass = document.getElementById('loginPass').value;

                if (!email || !pass) return alert("Por favor ingresa usuario y contrase√±a.");

                ui.toggleLoading(true); // Will be disabled by auth listener or catch

                try {
                    await auth.login(email, pass);
                    // UI changes handled by onAuthStateChanged listener in auth.init()
                } catch (e) {
                    ui.toggleLoading(false);
                    alert('Error: ' + e.message);
                }
            },

            showRecover() {
                document.getElementById('viewLogin').style.display = 'none';
                document.getElementById('viewRecover').style.display = 'block';
            },

            showLogin() {
                document.getElementById('viewLogin').style.display = 'block';
                document.getElementById('viewRecover').style.display = 'none';
            },

            async fetchSecurityQuestion() {
                const email = document.getElementById('recEmail').value;
                if (!email) return;
                const user = await dbService.get('users', email);
                if (user) {
                    document.getElementById('recQuestionDisplay').innerText = user.securityQ;
                    document.getElementById('recAnswer').classList.remove('hidden');
                    document.getElementById('recNewPass').classList.remove('hidden');
                    document.getElementById('btnResetPass').classList.remove('hidden');
                    document.getElementById('btnRecoverInfo').classList.add('hidden');
                } else {
                    alert('Usuario no encontrado');
                }
            },

            async handleRecover() {
                const email = document.getElementById('recEmail').value;
                const answer = document.getElementById('recAnswer').value;
                const newPass = document.getElementById('recNewPass').value;
                try {
                    await auth.recoverPassword(email, answer, newPass);
                    alert('Contrase√±a actualizada. Por favor inicia sesi√≥n.');
                    this.showLogin();
                } catch (e) { alert(e.message); }
            },

            showInviteModal() {
                const email = prompt("Ingresa el correo del nuevo usuario:");
                if (email) {
                    try {
                        auth.inviteUser(email, 'user'); // Default role user
                        // Mailto opened
                    } catch (e) { alert(e.message); }
                }
            },

            actualizarUMA() {
                const year = document.getElementById('yearSelect').value;
                // Daily UMA Values
                const umas = {
                    2025: 113.14,
                    2024: 108.57,
                    2023: 103.74,
                    2022: 96.22,
                    2021: 89.62,
                    2020: 86.88
                };
                if (umas[year]) document.getElementById('umaValue').value = umas[year].toFixed(2);
            },

            filtrarTabla(tid, txt) {
                // Basic DOM filter - Re-implements simple filtering or re-renders
                // Enhanced: just filter DOM rows for speed
                const rows = document.querySelectorAll(`#${tid} tbody tr`);
                rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(txt.toLowerCase()) ? '' : 'none');
            },

            // Modal Logic
            closeModal() { document.getElementById('genericModal').classList.remove('active'); },

            async openClientModal(id) {
                // Fetch latest from DB to be sure
                const client = (await dbService.getAll('kyc')).find(c => c.playercode === id);
                if (!client) return;

                const html = `
                    <h2>üìù Editar Cliente: ${client.username}</h2>
                    <br>
                    <div class="form-grid">
                        <div class="form-group"><label>Nombre</label><input id="m_nombre" value="${client.nombre}"></div>
                        <div class="form-group"><label>Apellido</label><input id="m_apellido" value="${client.apellido}"></div>
                        <div class="form-group"><label>Email</label><input id="m_email" value="${client.email}"></div>
                        <div class="form-group"><label>RFC</label><input id="m_rfc" value="${client.rfc}"></div>
                        <div class="form-group"><label>CURP</label><input id="m_curp" value="${client.curp}"></div>
                        <div class="form-group"><label>Direcci√≥n</label><input id="m_direccion" value="${client.direccion}"></div>
                        <div class="form-group"><label>CP</label><input id="m_cp" value="${client.cp}"></div>
                    </div>
                    <div class="btn-group" style="justify-content: flex-end;">
                        <button class="btn btn-primary" onclick="ui.saveClientModal('${client.playercode}')">üíæ Guardar Cambios</button>
                    </div>
                `;
                document.getElementById('modalBody').innerHTML = html;
                document.getElementById('genericModal').classList.add('active');
            },

            saveClientModal(id) {
                const c = {
                    playercode: id,
                    nombre: document.getElementById('m_nombre').value,
                    apellido: document.getElementById('m_apellido').value,
                    email: document.getElementById('m_email').value,
                    rfc: document.getElementById('m_rfc').value,
                    curp: document.getElementById('m_curp').value,
                    direccion: document.getElementById('m_direccion').value,
                    cp: document.getElementById('m_cp').value,
                    username: document.querySelector('#modalBody h2').innerText.split(': ')[1], // Hacky but works or fetch original
                    updated: new Date().toISOString()
                };
                app.guardarKYC(c);
                app.logAction('EDIT_KYC', `Modificaci√≥n manual de cliente: ${id} (${c.rfc})`);
                this.closeModal();
            }
        };

        function switchTab(t, e) {
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            if (e && e.currentTarget) {
                e.currentTarget.classList.add('active');
            } else if (e && e.target) {
                e.target.classList.add('active');
            }
            ui.updateTabs(t);

            // Fix: Re-render charts when switching to KYC tab so they have dimensions
            if (t === 'kyc' && app.currentData && app.currentData.kyc) {
                setTimeout(() => ui.renderKYCDashboard(app.currentData.kyc), 50);
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => app.init());

        // Setup Drag&Drop
        const drop = document.getElementById('dropExcel');
        drop.addEventListener('dragover', e => { e.preventDefault(); drop.style.background = '#e3f2fd'; });
        drop.addEventListener('drop', e => { e.preventDefault(); document.getElementById('fileExcel').files = e.dataTransfer.files; app.procesarArchivo(); });

    </script>
</body>

</html>