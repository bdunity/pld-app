<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Avisos LFPIORPI - 10bet Casino</title>
    
    <!-- Librer√≠as externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #1a4d8f;
            --secondary: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
            --info: #3498db;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --white: #ffffff;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, #2563a8 100%);
            color: var(--white);
            padding: 30px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo-container {
            background: var(--white);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .logo-container img {
            height: 60px;
            max-width: 250px;
            object-fit: contain;
        }
        
        .header-title {
            flex: 1;
            text-align: center;
            min-width: 300px;
        }
        
        .header-title h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header-title p {
            font-size: 1em;
            opacity: 0.95;
        }
        
        .confidentiality-notice {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: var(--white);
            padding: 20px 30px;
            text-align: center;
            border-left: 5px solid var(--danger);
            font-weight: 500;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .confidentiality-notice strong {
            font-size: 1.2em;
            display: block;
            margin-bottom: 10px;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--light);
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 15px 25px;
            background: var(--light);
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--dark);
        }
        
        .tab:hover {
            background: #d5dbdb;
        }
        
        .tab.active {
            background: var(--primary);
            color: var(--white);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section {
            background: var(--white);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }
        
        .section-header h2 {
            color: var(--primary);
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .badge {
            background: var(--primary);
            color: var(--white);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid var(--light);
            border-radius: 6px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 77, 143, 0.1);
        }
        
        .file-upload-area {
            border: 3px dashed var(--light);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .file-upload-area:hover {
            border-color: var(--primary);
            background: #e3f2fd;
        }
        
        .file-upload-area input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            top: 0;
            left: 0;
        }
        
        .upload-icon {
            font-size: 3.5em;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 12px;
            background: var(--white);
            border-radius: 6px;
            font-size: 0.95em;
            color: var(--success);
            font-weight: 600;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #2563a8 100%); color: var(--white); }
        .btn-success { background: linear-gradient(135deg, var(--success) 0%, #229954 100%); color: var(--white); }
        .btn-warning { background: linear-gradient(135deg, var(--warning) 0%, #e67e22 100%); color: var(--white); }
        .btn-danger { background: linear-gradient(135deg, var(--danger) 0%, #a93226 100%); color: var(--white); }
        .btn-info { background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%); color: var(--white); }
        
        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--white);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .stat-card.success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .stat-card.warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-card.info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card.danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
        
        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 8px;
        }
        
        .stat-card p {
            font-size: 1em;
            opacity: 0.95;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            font-size: 0.9em;
        }
        
        thead {
            background: linear-gradient(135deg, var(--primary) 0%, #2563a8 100%);
            color: var(--white);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--light);
        }
        
        tbody tr:hover {
            background: var(--light);
        }
        
        tbody tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-warning { background: #fff3cd; border-left: 4px solid var(--warning); color: #856404; }
        .alert-danger { background: #f8d7da; border-left: 4px solid var(--danger); color: #721c24; }
        .alert-success { background: #d4edda; border-left: 4px solid var(--success); color: #155724; }
        .alert-info { background: #d1ecf1; border-left: 4px solid var(--info); color: #0c5460; }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid var(--light);
            border-radius: 6px;
            font-size: 1em;
        }
        
        .search-box::after {
            content: "üîç";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid var(--light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .badge-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .badge-status.identificacion {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-status.aviso {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-status.normal {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-status.monitoreo {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .compliance-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .compliance-indicator.on-time {
            background: #d4edda;
            border-left: 4px solid var(--success);
        }
        
        .compliance-indicator.at-risk {
            background: #fff3cd;
            border-left: 4px solid var(--warning);
        }
        
        .compliance-indicator.overdue {
            background: #f8d7da;
            border-left: 4px solid var(--danger);
        }
        
        .report-card {
            background: var(--white);
            border: 2px solid var(--light);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .report-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .report-title {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .report-date {
            color: var(--dark);
            font-size: 0.9em;
        }
        
        .editable-cell {
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .editable-cell:hover {
            background: #e3f2fd;
        }
        
        .editing-cell {
            background: #fff9c4;
        }
        
        footer {
            background: var(--dark);
            color: var(--white);
            padding: 25px 30px;
            text-align: center;
        }
        
        footer p {
            margin: 5px 0;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .header-title h1 {
                font-size: 1.5em;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <img src="https://thumbs2.imgbox.com/a5/db/28bD5e7C_t.jpg" alt="BDU Logo">
                </div>
                <div class="header-title">
                    <h1>Sistema de Avisos PLD/FT</h1>
                    <p>10bet Casino - Generador Conforme a LFPIORPI</p>
                    <p style="font-size: 0.85em; opacity: 0.8;">RFC: SPE091216B35</p>
                </div>
            </div>
        </header>
        
        <div class="confidentiality-notice">
            <strong>‚ö†Ô∏è INFORMACI√ìN CONFIDENCIAL</strong>
            Este sistema contiene informaci√≥n protegida bajo la Ley Federal para la Prevenci√≥n e Identificaci√≥n de Operaciones con Recursos de Procedencia Il√≠cita (LFPIORPI). 
            La informaci√≥n debe conservarse por un per√≠odo m√≠nimo de 10 a√±os. Acceso restringido a personal autorizado.
        </div>
        
        <main class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('config')">‚öôÔ∏è Configuraci√≥n</button>
                <button class="tab" onclick="switchTab('upload')">üìÅ Carga de Datos</button>
                <button class="tab" onclick="switchTab('operations')">üìä Operaciones</button>
                <button class="tab" onclick="switchTab('monitoring')">üìà Monitoreo 6 Meses</button>
                <button class="tab" onclick="switchTab('kyc')">üë• Padr√≥n KYC</button>
                <button class="tab" onclick="switchTab('export')">üì§ Exportar</button>
                <button class="tab" onclick="switchTab('reports')">üìã Banco de Reportes</button>
            </div>
            
            <!-- Tab: Configuraci√≥n -->
            <div id="tab-config" class="tab-content active">
                <div class="section">
                    <div class="section-header">
                        <h2>‚öôÔ∏è Configuraci√≥n General</h2>
                        <span class="badge">RFC: SPE091216B35</span>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>RFC del Sujeto Obligado:</label>
                            <input type="text" id="rfcSujetoObligado" value="SPE091216B35" maxlength="13">
                        </div>
                        
                        <div class="form-group">
                            <label>Raz√≥n Social:</label>
                            <input type="text" id="razonSocial" value="10BET CASINO EN L√çNEA">
                        </div>
                        
                        <div class="form-group">
                            <label>A√±o de Referencia UMA:</label>
                            <select id="yearSelect" onchange="actualizarUMA()">
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Valor UMA Anual (MXN):</label>
                            <input type="number" id="umaValue" value="38610.00" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label>Umbral para Aviso (UMA):</label>
                            <input type="number" id="thresholdAviso" value="645" step="1">
                        </div>
                        
                        <div class="form-group">
                            <label>Umbral Monitoreo 6 Meses (UMA):</label>
                            <input type="number" id="thresholdMonitoreo" value="325" step="1">
                        </div>
                        
                        <div class="form-group">
                            <label>Responsable de Cumplimiento:</label>
                            <input type="text" id="responsableCumplimiento" value="Oficial de Cumplimiento">
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card info">
                            <h3 id="calcUmaValue">$38,610.00</h3>
                            <p>Valor UMA Anual</p>
                        </div>
                        <div class="stat-card warning">
                            <h3 id="calcAviso">$24,903,450.00</h3>
                            <p>Umbral de Aviso (645 UMA)</p>
                        </div>
                        <div class="stat-card info">
                            <h3 id="calcMonitoreo">$12,548,250.00</h3>
                            <p>Umbral Monitoreo (325 UMA)</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>‚ÑπÔ∏è Recordatorio Legal:</strong>
                        Los avisos deben presentarse a m√°s tardar el d√≠a 17 del mes siguiente en que se realiz√≥ el acto u operaci√≥n, a la Unidad de Inteligencia Financiera por conducto del SAT.
                    </div>
                    
                    <div class="alert alert-warning">
                        <strong>üìà Monitoreo 6 Meses:</strong>
                        Se deber√° dar seguimiento y agrupar aquellos actos u operaciones mayores o equivalentes a 325 UMA, y en un periodo de 6 meses superen el monto acumulado equivalente a 645 UMA.
                    </div>
                    
                    <button class="btn btn-primary" onclick="guardarConfiguracion()">
                        üíæ Guardar Configuraci√≥n
                    </button>
                </div>
            </div>
            
            <!-- Tab: Carga de Datos -->
            <div id="tab-upload" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <h2>üìÅ Carga de Archivo Mensual</h2>
                        <span class="badge">Excel AML Monthly</span>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>üìã Formato requerido:</strong>
                        El archivo debe contener las hojas "Deposits" y "Withdrawals" con los datos mensuales de operaciones.
                    </div>
                    
                    <div class="file-upload-area" id="dropExcel">
                        <div class="upload-icon">üìä</div>
                        <p><strong>Arrastra el archivo Excel mensual aqu√≠</strong></p>
                        <p>o haz clic para seleccionar</p>
                        <p style="font-size: 0.85em; color: #7f8c8d; margin-top: 10px;">Formato: XX__10bet_MX_AML_Monthly.xlsx</p>
                        <input type="file" id="fileExcel" accept=".xlsx,.xls">
                        <div id="infoExcel" class="file-info hidden"></div>
                    </div>
                    
                    <div class="loading" id="loadingProcess">
                        <div class="spinner"></div>
                        <p><strong>Procesando archivo...</strong></p>
                        <p style="font-size: 0.9em; color: var(--dark);">Analizando dep√≥sitos, retiros y actualizando padr√≥n KYC</p>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="procesarArchivo()">
                            üîÑ Procesar Datos
                        </button>
                        <button class="btn btn-danger" onclick="limpiarDatos()">
                            üóëÔ∏è Limpiar Todo
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Operaciones -->
            <div id="tab-operations" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <h2>üìä Resumen de Operaciones</h2>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <span class="badge" id="periodoReporte">Per√≠odo: N/A</span>
                            <select id="periodoSelector" onchange="actualizarPeriodo()" style="padding: 8px 15px; border-radius: 20px; border: 2px solid var(--primary); font-weight: 600; background: white;">
                                <option value="">Seleccionar per√≠odo...</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="complianceStatus" class="compliance-indicator">
                        <strong>üìÖ Estado de Cumplimiento:</strong>
                        <span id="complianceText">Sin datos para evaluar</span>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="totalDepositos">0</h3>
                            <p>Total Dep√≥sitos</p>
                        </div>
                        <div class="stat-card success">
                            <h3 id="totalRetiros">0</h3>
                            <p>Total Retiros</p>
                        </div>
                        <div class="stat-card warning">
                            <h3 id="totalParaAviso">0</h3>
                            <p>Operaciones para Aviso</p>
                        </div>
                        <div class="stat-card info">
                            <h3 id="totalClientes">0</h3>
                            <p>Clientes √önicos</p>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2>üí∞ Dep√≥sitos Mensuales</h2>
                        <button class="btn btn-primary btn-sm" onclick="exportarOperaciones('depositos', 'excel')">
                            üìä Exportar Excel
                        </button>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="searchDepositos" placeholder="Buscar en dep√≥sitos..." onkeyup="filtrarTabla('depositosTable', 'searchDepositos')">
                    </div>
                    
                    <div class="table-container">
                        <table id="depositosTable">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Nombre</th>
                                    <th>Monto Mensual</th>
                                    <th>Monto Total</th>
                                    <th>Veces Umbral</th>
                                    <th>UMA</th>
                                    <th>Email</th>
                                    <th>Tel√©fono</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="depositosBody">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px; color: #7f8c8d;">
                                        Sin datos. Carga un archivo Excel para comenzar.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2>üé∞ Retiros Mensuales</h2>
                        <button class="btn btn-primary btn-sm" onclick="exportarOperaciones('retiros', 'excel')">
                            üìä Exportar Excel
                        </button>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="searchRetiros" placeholder="Buscar en retiros..." onkeyup="filtrarTabla('retirosTable', 'searchRetiros')">
                    </div>
                    
                    <div class="table-container">
                        <table id="retirosTable">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Nombre</th>
                                    <th>Monto Mensual</th>
                                    <th>Monto Total</th>
                                    <th>Veces Umbral</th>
                                    <th>UMA</th>
                                    <th>Email</th>
                                    <th>Tel√©fono</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="retirosBody">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px; color: #7f8c8d;">
                                        Sin datos. Carga un archivo Excel para comenzar.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Monitoreo 6 Meses -->
            <div id="tab-monitoring" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <h2>üìà Monitoreo Acumulado 6 Meses</h2>
                        <span class="badge">325 UMA ‚Üí 645 UMA</span>
                    </div>
                    
                    <div class="alert alert-warning">
                        <strong>üìä Criterio de Monitoreo:</strong>
                        Se rastrean clientes con operaciones individuales ‚â• 325 UMA que al acumularse en 6 meses superen 645 UMA. Estos clientes requieren seguimiento especial y posible reporte.
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card warning">
                            <h3 id="clientesMonitoreo">0</h3>
                            <p>Clientes en Monitoreo</p>
                        </div>
                        <div class="stat-card danger">
                            <h3 id="clientesAlerta">0</h3>
                            <p>Superan 645 UMA (6 meses)</p>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-info" onclick="calcularMonitoreo6Meses()">
                            üîÑ Actualizar Monitoreo
                        </button>
                        <button class="btn btn-success" onclick="exportarMonitoreo()">
                            üìä Exportar Monitoreo
                        </button>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2>üîç Clientes en Seguimiento</h2>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="searchMonitoreo" placeholder="Buscar clientes en monitoreo..." onkeyup="filtrarTabla('monitoreoTable', 'searchMonitoreo')">
                    </div>
                    
                    <div class="table-container">
                        <table id="monitoreoTable">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Nombre</th>
                                    <th>Operaciones (6 meses)</th>
                                    <th>Monto Acumulado</th>
                                    <th>UMA Acumulado</th>
                                    <th>Estado</th>
                                    <th>Per√≠odo</th>
                                </tr>
                            </thead>
                            <tbody id="monitoreoBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #7f8c8d;">
                                        Sin datos de monitoreo. Procesa archivos de varios meses para ver el seguimiento.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Padr√≥n KYC -->
            <div id="tab-kyc" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <h2>üë• Padr√≥n de Clientes (KYC)</h2>
                        <span class="badge" id="totalKYC">0 clientes</span>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>‚úèÔ∏è Edici√≥n:</strong>
                        Haz clic en cualquier celda para editarla. Los cambios se guardan autom√°ticamente.
                    </div>
                    
                    <div class="btn-group" style="margin-bottom: 20px;">
                        <button class="btn btn-info" onclick="seleccionarTodosKYC()">
                            ‚òëÔ∏è Seleccionar Todos
                        </button>
                        <button class="btn btn-warning" onclick="limpiarSeleccionadosKYC()">
                            üßπ Limpiar Seleccionados
                        </button>
                        <button class="btn btn-danger" onclick="eliminarSeleccionadosKYC()">
                            üóëÔ∏è Eliminar Seleccionados
                        </button>
                        <span id="contadorSeleccionados" style="padding: 10px; font-weight: 600; color: var(--primary);">
                            0 seleccionados
                        </span>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="searchKYC" placeholder="Buscar por nombre, usuario, RFC, CURP, email..." onkeyup="filtrarTabla('kycTable', 'searchKYC')">
                    </div>
                    
                    <div class="table-container">
                        <table id="kycTable">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAllKYC" onchange="toggleSeleccionarTodos()" style="cursor: pointer; width: 18px; height: 18px;">
                                    </th>
                                    <th>Estado</th>
                                    <th>ID Usuario</th>
                                    <th>Usuario</th>
                                    <th>Nombre</th>
                                    <th>Apellidos</th>
                                    <th>Email</th>
                                    <th>Tel√©fono</th>
                                    <th>RFC</th>
                                    <th>CURP</th>
                                    <th>Fecha Nac.</th>
                                    <th>Direcci√≥n</th>
                                    <th>CP</th>
                                    <th>Actividad Econ√≥mica</th>
                                </tr>
                            </thead>
                            <tbody id="kycBody">
                                <tr>
                                    <td colspan="14" style="text-align: center; padding: 40px; color: #7f8c8d;">
                                        Sin datos. Carga un archivo Excel para construir el padr√≥n.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="exportarKYC('excel')">
                            üìä Exportar Excel
                        </button>
                        <button class="btn btn-warning" onclick="exportarKYC('pdf')">
                            üìÑ Exportar PDF
                        </button>
                        <button class="btn btn-info" onclick="guardarPadronKYC()">
                            üíæ Guardar Padr√≥n
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Exportar -->
            <div id="tab-export" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <h2>üì§ Generaci√≥n de Avisos UIF</h2>
                        <span class="badge">XML Oficial</span>
                    </div>
                    
                    <div class="alert alert-success">
                        <strong>‚úÖ Formato Oficial:</strong>
                        El sistema genera DOS archivos XML separados (uno para dep√≥sitos y otro para retiros) que cumplen con la estructura oficial requerida por la Unidad de Inteligencia Financiera (esquema jys.xsd).
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>üìã Avisos Mensuales:</strong>
                        Se generan 2 avisos por mes: uno para operaciones de dep√≥sitos y otro para operaciones de retiros/premios que superen el umbral de 645 UMA.
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card warning">
                            <h3 id="avisoDepositos">0</h3>
                            <p>Dep√≥sitos para Aviso</p>
                        </div>
                        <div class="stat-card danger">
                            <h3 id="avisoRetiros">0</h3>
                            <p>Retiros para Aviso</p>
                        </div>
                        <div class="stat-card info">
                            <h3 id="avisoTotal">0</h3>
                            <p>Total de Operaciones</p>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="generarXMLUIF()">
                            üìÑ Generar XML UIF (Ambos)
                        </button>
                        <button class="btn btn-warning" onclick="generarPDFValidacion()">
                            üìã PDF de Validaci√≥n
                        </button>
                        <button class="btn btn-info" onclick="generarReporteCompleto()">
                            üìä Reporte Completo
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Banco de Reportes -->
            <div id="tab-reports" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <h2>üìã Banco de Reportes Hist√≥ricos</h2>
                        <span class="badge" id="totalReportes">0 reportes</span>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>üìö Conservaci√≥n:</strong>
                        Todos los reportes generados se almacenan localmente conforme al requisito de conservaci√≥n de 10 a√±os de la LFPIORPI.
                    </div>
                    
                    <div id="reportesContainer">
                        <p style="text-align: center; padding: 40px; color: #7f8c8d;">
                            No hay reportes almacenados. Genera tu primer reporte en la pesta√±a "Exportar".
                        </p>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="cargarReportesHistoricos()">
                            üîÑ Actualizar Lista
                        </button>
                        <button class="btn btn-warning" onclick="exportarBancoReportes()">
                            üì¶ Exportar Banco Completo
                        </button>
                    </div>
                </div>
            </div>
        </main>
        
        <footer>
            <p><strong>Business Development Unity - BDU</strong></p>
            <p>Sistema de Gesti√≥n de Avisos PLD/FT | LFPIORPI</p>
            <p>&copy; 2025 - Informaci√≥n Confidencial - RFC: SPE091216B35</p>
        </footer>
    </div>
    
    <script>
        // Variables globales
        let datosDepositos = [];
        let datosRetiros = [];
        let historialOperaciones = []; // Para monitoreo de 6 meses
        let padronKYC = new Map();
        let configuracion = {
            rfcSujetoObligado: 'SPE091216B35',
            razonSocial: '10BET CASINO EN L√çNEA',
            year: 2025,
            umaValue: 38610.00,
            thresholdAviso: 645,
            thresholdMonitoreo: 325,
            responsableCumplimiento: 'Oficial de Cumplimiento'
        };
        let bancoReportes = [];
        let periodoActual = { year: null, month: null };
        
        // Mapeo de meses
        const mesesNombre = {
            1: 'Enero', 2: 'Febrero', 3: 'Marzo', 4: 'Abril',
            5: 'Mayo', 6: 'Junio', 7: 'Julio', 8: 'Agosto',
            9: 'Septiembre', 10: 'Octubre', 11: 'Noviembre', 12: 'Diciembre'
        };
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            cargarConfiguracion();
            cargarPadronKYC();
            cargarBancoReportes();
            cargarHistorialOperaciones();
            actualizarUMA();
            setupDragAndDrop();
            setupFileHandler();
        });
        
        // Setup para manejar la carga del archivo
        function setupFileHandler() {
            const fileInput = document.getElementById('fileExcel');
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const infoElement = document.getElementById('infoExcel');
                    infoElement.classList.remove('hidden');
                    infoElement.innerHTML = `‚úÖ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                }
            });
        }
        
        // Tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            if (tabName === 'monitoring') {
                calcularMonitoreo6Meses();
            }
        }
        
        // Drag and Drop
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropExcel');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--success)';
                dropZone.style.background = '#e8f5e9';
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.borderColor = '';
                dropZone.style.background = '';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '';
                dropZone.style.background = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('fileExcel').files = files;
                    const infoElement = document.getElementById('infoExcel');
                    infoElement.classList.remove('hidden');
                    infoElement.innerHTML = `‚úÖ ${files[0].name} (${(files[0].size / 1024 / 1024).toFixed(2)} MB)`;
                }
            });
        }
        
        // Actualizar UMA
        function actualizarUMA() {
            const year = parseInt(document.getElementById('yearSelect').value);
            const umaValues = {
                2024: 37400.91,
                2025: 38610.00,
                2026: 39850.00
            };
            
            document.getElementById('umaValue').value = umaValues[year] || 38610.00;
            calcularUmbrales();
        }
        
        // Calcular umbrales
        function calcularUmbrales() {
            configuracion.umaValue = parseFloat(document.getElementById('umaValue').value);
            configuracion.thresholdAviso = parseInt(document.getElementById('thresholdAviso').value);
            configuracion.thresholdMonitoreo = parseInt(document.getElementById('thresholdMonitoreo').value);
            
            const montoAviso = configuracion.umaValue * configuracion.thresholdAviso;
            const montoMonitoreo = configuracion.umaValue * configuracion.thresholdMonitoreo;
            
            document.getElementById('calcUmaValue').textContent = formatCurrency(configuracion.umaValue);
            document.getElementById('calcAviso').textContent = formatCurrency(montoAviso);
            document.getElementById('calcMonitoreo').textContent = formatCurrency(montoMonitoreo);
        }
        
        // Procesar archivo - VERSI√ìN ULTRA CORREGIDA
        function procesarArchivo() {
            const fileInput = document.getElementById('fileExcel');
            if (!fileInput.files || fileInput.files.length === 0) {
                mostrarAlerta('Por favor, selecciona un archivo Excel', 'danger');
                return;
            }
            
            const file = fileInput.files[0];
            document.getElementById('loadingProcess').classList.add('active');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array', 
                        cellDates: true,
                        cellNF: false,
                        cellText: false
                    });
                    
                    console.log('='.repeat(70));
                    console.log('üìÅ INICIANDO PROCESAMIENTO DE ARCHIVO');
                    console.log('='.repeat(70));
                    console.log('üìÅ Hojas disponibles:', workbook.SheetNames);
                    
                    // Procesar dep√≥sitos
                    if (workbook.SheetNames.includes('Deposits')) {
                        console.log('\nüîÑ Procesando hoja Deposits...');
                        const depositsSheet = workbook.Sheets['Deposits'];
                        
                        // Leer con range: 5 (fila 6 como encabezados, fila 7+ como datos)
                        const depositsData = XLSX.utils.sheet_to_json(depositsSheet, { 
                            range: 5,
                            raw: false,  // Convierte n√∫meros a strings
                            defval: '',
                            blankrows: false  // Ignorar filas vac√≠as
                        });
                        
                        console.log(`‚úÖ Dep√≥sitos encontrados: ${depositsData.length} registros`);
                        
                        if (depositsData.length > 0) {
                            console.log('üìä Muestra del primer registro:');
                            const muestra = depositsData[0];
                            console.log('   playercode:', muestra.playercode || muestra.B);
                            console.log('   USERNAME:', muestra.USERNAME || muestra.C);
                            console.log('   FIRSTNAME:', muestra.FIRSTNAME || muestra.K);
                            console.log('   Monthly Depostis:', muestra['Monthly Depostis'] || muestra.H);
                            console.log('   Period Month:', muestra['Period Month'] || muestra.F);
                            console.log('   Objeto completo:', muestra);
                        }
                        
                        datosDepositos = procesarOperaciones(depositsData, 'deposito');
                        console.log(`‚úÖ Dep√≥sitos procesados exitosamente: ${datosDepositos.length}`);
                    } else {
                        console.warn('‚ö†Ô∏è Hoja "Deposits" no encontrada');
                    }
                    
                    // Procesar retiros
                    if (workbook.SheetNames.includes('Withdrawals')) {
                        console.log('\nüîÑ Procesando hoja Withdrawals...');
                        const withdrawalsSheet = workbook.Sheets['Withdrawals'];
                        
                        // IMPORTANTE: En Withdrawals los encabezados est√°n en FILA 3, no en FILA 6
                        // Por eso usamos range: 2 (fila 3 como encabezados, fila 4+ como datos)
                        const withdrawalsData = XLSX.utils.sheet_to_json(withdrawalsSheet, { 
                            range: 2,
                            raw: false,
                            defval: '',
                            blankrows: false
                        });
                        
                        console.log(`‚úÖ Retiros encontrados: ${withdrawalsData.length} registros`);
                        
                        if (withdrawalsData.length > 0) {
                            console.log('üìä Muestra del primer registro:');
                            const muestra = withdrawalsData[0];
                            console.log('   playercode:', muestra.playercode || muestra.B);
                            console.log('   USERNAME:', muestra.USERNAME || muestra.C);
                            console.log('   Monthly Withdrawals:', muestra['Monthly Withdrawals'] || muestra.H);
                        }
                        
                        datosRetiros = procesarOperaciones(withdrawalsData, 'retiro');
                        console.log(`‚úÖ Retiros procesados exitosamente: ${datosRetiros.length}`);
                    } else {
                        console.warn('‚ö†Ô∏è Hoja "Withdrawals" no encontrada');
                    }
                    
                    console.log('='.repeat(70));
                    console.log(`üìä RESUMEN: ${datosDepositos.length} dep√≥sitos, ${datosRetiros.length} retiros`);
                    console.log('='.repeat(70));
                    
                    if (datosDepositos.length === 0 && datosRetiros.length === 0) {
                        document.getElementById('loadingProcess').classList.remove('active');
                        mostrarAlerta('‚ùå No se encontraron datos para procesar. Abre la consola (F12) para ver detalles del archivo.', 'danger');
                        return;
                    }
                    
                    // Agregar al historial para monitoreo de 6 meses
                    agregarAHistorial([...datosDepositos, ...datosRetiros]);
                    
                    // Actualizar padr√≥n KYC
                    actualizarPadronKYC([...datosDepositos, ...datosRetiros]);
                    
                    // Mostrar resultados
                    mostrarDatos();
                    
                    document.getElementById('loadingProcess').classList.remove('active');
                    mostrarAlerta(`‚úÖ Archivo procesado exitosamente: ${datosDepositos.length} dep√≥sitos y ${datosRetiros.length} retiros`, 'success');
                    
                    // Cambiar a tab de operaciones
                    switchTab('operations');
                    
                } catch (error) {
                    document.getElementById('loadingProcess').classList.remove('active');
                    mostrarAlerta('‚ùå Error al procesar el archivo: ' + error.message, 'danger');
                    console.error('‚ùå ERROR DETALLADO:', error);
                    console.error('Stack trace:', error.stack);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Procesar operaciones - VERSI√ìN MEJORADA
        function procesarOperaciones(data, tipo) {
            if (!data || data.length === 0) {
                console.log(`‚ö†Ô∏è No hay datos de ${tipo} para procesar`);
                return [];
            }
            
            const umaValue = configuracion.umaValue;
            const threshold = configuracion.thresholdAviso;
            const montoUmbral = umaValue * threshold;
            
            console.log(`üîÑ Procesando ${data.length} registros de ${tipo}...`);
            
            const resultado = data.map((row, index) => {
                try {
                    // Para retiros, las columnas tienen nombres diferentes
                    let montoMensual, montoTotal;
                    
                    if (tipo === 'retiro') {
                        montoMensual = parseFloat(row['Monthly Withdrawals'] || row['H'] || 0);
                        montoTotal = parseFloat(row['LT Withdrawals'] || row['G'] || 0);
                    } else {
                        montoMensual = parseFloat(row['Monthly Depostis'] || row['H'] || 0);
                        montoTotal = parseFloat(row['LT Deposits'] || row['G'] || 0);
                    }
                    
                    // Validar monto
                    if (isNaN(montoMensual) || montoMensual <= 0) {
                        return null;
                    }
                    
                    const umaEquivalente = montoMensual / umaValue;
                    
                    // Determinar periodo
                    const year = parseInt(row['Period Year'] || row['E'] || new Date().getFullYear());
                    const month = parseInt(row['Period Month'] || row['F'] || new Date().getMonth() + 1);
                    periodoActual = { year, month };
                    
                    let estado = 'normal';
                    if (montoMensual >= montoUmbral) {
                        estado = 'aviso';
                    }
                    
                    return {
                        playercode: String(row['playercode'] || row['B'] || ''),
                        username: String(row['USERNAME'] || row['C'] || ''),
                        firstname: tipo === 'retiro' ? 
                            String(row['FIRSTNAME'] || row['J'] || '').toUpperCase() : 
                            String(row['FIRSTNAME'] || row['K'] || '').toUpperCase(),
                        lastname: tipo === 'retiro' ? 
                            String(row['LASTNAME'] || row['K'] || '').toUpperCase() : 
                            String(row['LASTNAME'] || row['L'] || '').toUpperCase(),
                        email: tipo === 'retiro' ? 
                            String(row['EMAIL'] || row['R'] || '').toLowerCase() : 
                            String(row['EMAIL'] || row['S'] || '').toLowerCase(),
                        phone: tipo === 'retiro' ? 
                            String(row['PHONE'] || row['S'] || '') : 
                            String(row['PHONE'] || row['T'] || ''),
                        rfc: tipo === 'retiro' ? 
                            String(row['RFC'] || row['Y'] || '') : 
                            String(row['RFC'] || row['Z'] || ''),
                        curp: tipo === 'retiro' ? 
                            String(row['CURP'] || row['Z'] || '') : 
                            String(row['CURP'] || row['AA'] || ''),
                        dob: tipo === 'retiro' ? 
                            (row['DOB'] || row['N'] || '') : 
                            (row['DOB'] || row['O'] || ''),
                        address: tipo === 'retiro' ? 
                            String(row['ADDRESS'] || row['O'] || '') : 
                            String(row['ADDRESS'] || row['P'] || ''),
                        zip: tipo === 'retiro' ? 
                            String(row['ZIP'] || row['P'] || '') : 
                            String(row['ZIP'] || row['Q'] || ''),
                        gender: tipo === 'retiro' ? 
                            String(row['GENDER'] || row['L'] || '') : 
                            String(row['GENDER'] || row['M'] || ''),
                        age: tipo === 'retiro' ? 
                            (row['Age'] || row['M'] || '') : 
                            (row['Age'] || row['N'] || ''),
                        nationality: tipo === 'retiro' ? 
                            String(row['Nationality'] || row['T'] || 'Mexican') : 
                            String(row['Nationality'] || row['U'] || 'Mexican'),
                        actividadEconomica: '8230300',
                        montoMensual: montoMensual,
                        montoTotal: montoTotal,
                        umaEquivalente: umaEquivalente,
                        vecesUmbral: parseInt(row['Times Reached Thresh'] || row['I'] || 0),
                        estado: estado,
                        tipo: tipo,
                        year: year,
                        month: month
                    };
                } catch (error) {
                    console.error(`‚ùå Error procesando registro ${index}:`, error);
                    return null;
                }
            }).filter(op => op !== null);
            
            console.log(`‚úÖ ${tipo}: ${resultado.length} operaciones procesadas exitosamente`);
            return resultado;
        }
        
        // Agregar al historial para monitoreo
        function agregarAHistorial(operaciones) {
            operaciones.forEach(op => {
                historialOperaciones.push({
                    ...op,
                    fechaProceso: new Date().toISOString()
                });
            });
            
            // Guardar en localStorage
            localStorage.setItem('historialOperaciones', JSON.stringify(historialOperaciones));
        }
        
        // Cargar historial de operaciones
        function cargarHistorialOperaciones() {
            const stored = localStorage.getItem('historialOperaciones');
            if (stored) {
                historialOperaciones = JSON.parse(stored);
            }
        }
        
        // Calcular monitoreo de 6 meses
        function calcularMonitoreo6Meses() {
            const fechaActual = new Date();
            const fechaLimite = new Date();
            fechaLimite.setMonth(fechaLimite.getMonth() - 6);
            
            // Filtrar operaciones de los √∫ltimos 6 meses
            const operacionesRecientes = historialOperaciones.filter(op => {
                const fechaOp = new Date(op.year, op.month - 1);
                return fechaOp >= fechaLimite && fechaOp <= fechaActual;
            });
            
            // Agrupar por cliente
            const clientesMap = new Map();
            const umbralMonitoreo = configuracion.umaValue * configuracion.thresholdMonitoreo;
            const umbralAviso = configuracion.umaValue * configuracion.thresholdAviso;
            
            operacionesRecientes.forEach(op => {
                // Solo monitorear operaciones >= 325 UMA
                if (op.montoMensual >= umbralMonitoreo) {
                    if (!clientesMap.has(op.playercode)) {
                        clientesMap.set(op.playercode, {
                            playercode: op.playercode,
                            username: op.username,
                            firstname: op.firstname,
                            lastname: op.lastname,
                            operaciones: [],
                            montoAcumulado: 0,
                            umaAcumulado: 0
                        });
                    }
                    
                    const cliente = clientesMap.get(op.playercode);
                    cliente.operaciones.push(op);
                    cliente.montoAcumulado += op.montoMensual;
                    cliente.umaAcumulado += op.umaEquivalente;
                }
            });
            
            // Filtrar clientes que superan 645 UMA acumulado
            const clientesMonitoreo = Array.from(clientesMap.values());
            const clientesAlerta = clientesMonitoreo.filter(c => c.umaAcumulado >= configuracion.thresholdAviso);
            
            // Actualizar estad√≠sticas
            document.getElementById('clientesMonitoreo').textContent = clientesMonitoreo.length;
            document.getElementById('clientesAlerta').textContent = clientesAlerta.length;
            
            // Mostrar tabla
            mostrarTablaMonitoreo(clientesMonitoreo);
            
            if (clientesAlerta.length > 0) {
                mostrarAlerta(`‚ö†Ô∏è ${clientesAlerta.length} cliente(s) superan 645 UMA en 6 meses y requieren seguimiento especial`, 'warning');
            }
        }
        
        // Mostrar tabla de monitoreo
        function mostrarTablaMonitoreo(clientes) {
            const tbody = document.getElementById('monitoreoBody');
            tbody.innerHTML = '';
            
            if (clientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">Sin clientes en monitoreo</td></tr>';
                return;
            }
            
            const umbralAviso = configuracion.thresholdAviso;
            
            clientes.forEach(cliente => {
                const row = tbody.insertRow();
                const superaUmbral = cliente.umaAcumulado >= umbralAviso;
                const estadoClass = superaUmbral ? 'aviso' : 'monitoreo';
                const estadoTexto = superaUmbral ? '‚ö†Ô∏è Supera 645 UMA' : 'üëÅÔ∏è En Seguimiento';
                
                // Calcular per√≠odo de las operaciones
                const meses = [...new Set(cliente.operaciones.map(op => `${mesesNombre[op.month]}/${op.year}`))];
                const periodo = meses.length > 3 ? `${meses[0]} - ${meses[meses.length-1]}` : meses.join(', ');
                
                row.innerHTML = `
                    <td>${cliente.username}</td>
                    <td>${cliente.firstname} ${cliente.lastname}</td>
                    <td>${cliente.operaciones.length}</td>
                    <td>${formatCurrency(cliente.montoAcumulado)}</td>
                    <td>${cliente.umaAcumulado.toFixed(2)}</td>
                    <td><span class="badge-status ${estadoClass}">${estadoTexto}</span></td>
                    <td style="font-size: 0.85em;">${periodo}</td>
                `;
            });
        }
        
        // Exportar monitoreo
        function exportarMonitoreo() {
            const tbody = document.getElementById('monitoreoBody');
            if (tbody.children.length === 0 || tbody.children[0].children.length === 1) {
                mostrarAlerta('No hay datos de monitoreo para exportar', 'warning');
                return;
            }
            
            // Extraer datos de la tabla
            const datos = [];
            Array.from(tbody.children).forEach(row => {
                const cells = row.children;
                if (cells.length > 1) {
                    datos.push({
                        'Usuario': cells[0].textContent,
                        'Nombre': cells[1].textContent,
                        'Operaciones (6 meses)': cells[2].textContent,
                        'Monto Acumulado': cells[3].textContent,
                        'UMA Acumulado': cells[4].textContent,
                        'Estado': cells[5].textContent,
                        'Per√≠odo': cells[6].textContent
                    });
                }
            });
            
            const ws = XLSX.utils.json_to_sheet(datos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Monitoreo 6 Meses');
            
            XLSX.writeFile(wb, `Monitoreo_6_Meses_${new Date().toISOString().split('T')[0]}.xlsx`);
            mostrarAlerta('‚úÖ Monitoreo exportado a Excel', 'success');
        }
        
        // Actualizar padr√≥n KYC
        function actualizarPadronKYC(operaciones) {
            console.log(`üîÑ Actualizando padr√≥n KYC con ${operaciones.length} operaciones`);
            
            operaciones.forEach(op => {
                // IMPORTANTE: Convertir playercode a string para evitar problemas con n√∫meros grandes
                const playercodeKey = String(op.playercode);
                
                if (!padronKYC.has(playercodeKey)) {
                    console.log(`   ‚ûï Nuevo cliente: ${playercodeKey}`);
                    padronKYC.set(playercodeKey, {
                        playercode: playercodeKey, // Guardar como string
                        username: op.username,
                        firstname: op.firstname,
                        lastname: op.lastname,
                        email: op.email,
                        phone: op.phone,
                        rfc: op.rfc || '',
                        curp: op.curp || '',
                        dob: op.dob,
                        address: op.address,
                        zip: op.zip,
                        gender: op.gender,
                        age: op.age,
                        nationality: op.nationality,
                        actividadEconomica: op.actividadEconomica || '8230300',
                        fechaRegistro: new Date().toISOString()
                    });
                } else {
                    // Actualizar informaci√≥n si est√° vac√≠a
                    const cliente = padronKYC.get(playercodeKey);
                    if (!cliente.rfc && op.rfc) cliente.rfc = op.rfc;
                    if (!cliente.curp && op.curp) cliente.curp = op.curp;
                    if (!cliente.address && op.address) cliente.address = op.address;
                    if (!cliente.zip && op.zip) cliente.zip = op.zip;
                }
            });
            
            console.log(`‚úÖ Padr√≥n KYC actualizado: ${padronKYC.size} clientes totales`);
            
            guardarPadronKYC();
            mostrarPadronKYC();
        }
        
        // Mostrar datos
        function mostrarDatos() {
            // Actualizar resumen
            document.getElementById('totalDepositos').textContent = datosDepositos.length;
            document.getElementById('totalRetiros').textContent = datosRetiros.length;
            
            const depositosAviso = datosDepositos.filter(d => d.estado === 'aviso').length;
            const retirosAviso = datosRetiros.filter(d => d.estado === 'aviso').length;
            document.getElementById('totalParaAviso').textContent = depositosAviso + retirosAviso;
            document.getElementById('totalClientes').textContent = padronKYC.size;
            
            // Actualizar avisos
            document.getElementById('avisoDepositos').textContent = depositosAviso;
            document.getElementById('avisoRetiros').textContent = retirosAviso;
            document.getElementById('avisoTotal').textContent = depositosAviso + retirosAviso;
            
            // Actualizar per√≠odo
            if (periodoActual.year && periodoActual.month) {
                const periodoText = `${mesesNombre[periodoActual.month]} ${periodoActual.year}`;
                document.getElementById('periodoReporte').textContent = `Per√≠odo: ${periodoText}`;
                document.getElementById('periodoSelector').value = periodoActual.month;
                evaluarCumplimiento();
            }
            
            // Mostrar tablas
            mostrarTablaDepositos();
            mostrarTablaRetiros();
        }
        
        // Actualizar per√≠odo manualmente
        function actualizarPeriodo() {
            const mes = parseInt(document.getElementById('periodoSelector').value);
            if (!mes) {
                mostrarAlerta('Por favor selecciona un mes', 'warning');
                return;
            }
            
            const year = new Date().getFullYear();
            periodoActual = { year: year, month: mes };
            
            const periodoText = `${mesesNombre[mes]} ${year}`;
            document.getElementById('periodoReporte').textContent = `Per√≠odo: ${periodoText}`;
            
            evaluarCumplimiento();
            mostrarAlerta(`‚úÖ Per√≠odo actualizado a ${periodoText}`, 'success');
        }
        
        // Evaluar cumplimiento
        function evaluarCumplimiento() {
            const hoy = new Date();
            const fechaLimite = new Date(periodoActual.year, periodoActual.month, 17);
            const diasRestantes = Math.ceil((fechaLimite - hoy) / (1000 * 60 * 60 * 24));
            
            const indicator = document.getElementById('complianceStatus');
            const text = document.getElementById('complianceText');
            
            indicator.className = 'compliance-indicator';
            
            if (diasRestantes > 5) {
                indicator.classList.add('on-time');
                text.textContent = `‚úÖ A tiempo - ${diasRestantes} d√≠as restantes para presentar aviso`;
            } else if (diasRestantes > 0) {
                indicator.classList.add('at-risk');
                text.textContent = `‚ö†Ô∏è Pr√≥ximo a vencer - ${diasRestantes} d√≠as restantes`;
            } else {
                indicator.classList.add('overdue');
                text.textContent = `‚ùå Fuera de plazo - Vencido hace ${Math.abs(diasRestantes)} d√≠as`;
            }
        }
        
        // Mostrar tabla de dep√≥sitos
        function mostrarTablaDepositos() {
            const tbody = document.getElementById('depositosBody');
            tbody.innerHTML = '';
            
            if (datosDepositos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">Sin datos de dep√≥sitos</td></tr>';
                return;
            }
            
            datosDepositos.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.username}</td>
                    <td>${item.firstname} ${item.lastname}</td>
                    <td>${formatCurrency(item.montoMensual)}</td>
                    <td>${formatCurrency(item.montoTotal)}</td>
                    <td>${item.vecesUmbral}</td>
                    <td>${item.umaEquivalente.toFixed(2)}</td>
                    <td style="font-size: 0.85em;">${item.email}</td>
                    <td style="font-size: 0.85em;">${item.phone}</td>
                    <td><span class="badge-status ${item.estado}">${getEstadoTexto(item.estado)}</span></td>
                `;
            });
        }
        
        // Mostrar tabla de retiros
        function mostrarTablaRetiros() {
            const tbody = document.getElementById('retirosBody');
            tbody.innerHTML = '';
            
            if (datosRetiros.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">Sin datos de retiros</td></tr>';
                return;
            }
            
            datosRetiros.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.username}</td>
                    <td>${item.firstname} ${item.lastname}</td>
                    <td>${formatCurrency(item.montoMensual)}</td>
                    <td>${formatCurrency(item.montoTotal)}</td>
                    <td>${item.vecesUmbral}</td>
                    <td>${item.umaEquivalente.toFixed(2)}</td>
                    <td style="font-size: 0.85em;">${item.email}</td>
                    <td style="font-size: 0.85em;">${item.phone}</td>
                    <td><span class="badge-status ${item.estado}">${getEstadoTexto(item.estado)}</span></td>
                `;
            });
        }
        
        // Mostrar padr√≥n KYC
        function mostrarPadronKYC() {
            const tbody = document.getElementById('kycBody');
            tbody.innerHTML = '';
            
            document.getElementById('totalKYC').textContent = `${padronKYC.size} clientes`;
            
            if (padronKYC.size === 0) {
                tbody.innerHTML = '<tr><td colspan="14" style="text-align: center; padding: 40px;">Sin datos en el padr√≥n</td></tr>';
                return;
            }
            
            Array.from(padronKYC.values()).forEach((cliente) => {
                const row = tbody.insertRow();
                const dob = cliente.dob ? formatFechaNacimiento(cliente.dob) : '';
                
                // Convertir playercode a string SIN notaci√≥n cient√≠fica
                const playercodeStr = String(cliente.playercode);
                
                // Verificar campos completos
                const camposCompletos = 
                    cliente.firstname && cliente.lastname && cliente.email && cliente.phone && 
                    cliente.rfc && cliente.curp && cliente.dob && cliente.address && cliente.zip;
                
                const estadoIcono = camposCompletos ? 
                    '<span style="color: var(--success); font-size: 1.3em;" title="Informaci√≥n completa">‚úì</span>' : 
                    '<span style="color: var(--danger); font-size: 1.3em;" title="Informaci√≥n incompleta">‚úó</span>';
                
                row.innerHTML = `
                    <td style="text-align: center;">
                        <input type="checkbox" class="kyc-checkbox" data-playercode="${playercodeStr}" style="cursor: pointer; width: 18px; height: 18px;">
                    </td>
                    <td style="text-align: center;">${estadoIcono}</td>
                    <td>${playercodeStr}</td>
                    <td>${cliente.username}</td>
                    <td class="editable-cell" data-field="firstname" data-playercode="${playercodeStr}">${cliente.firstname}</td>
                    <td class="editable-cell" data-field="lastname" data-playercode="${playercodeStr}">${cliente.lastname}</td>
                    <td class="editable-cell" data-field="email" data-playercode="${playercodeStr}">${cliente.email}</td>
                    <td class="editable-cell" data-field="phone" data-playercode="${playercodeStr}">${cliente.phone}</td>
                    <td class="editable-cell" data-field="rfc" data-playercode="${playercodeStr}">${cliente.rfc}</td>
                    <td class="editable-cell" data-field="curp" data-playercode="${playercodeStr}">${cliente.curp}</td>
                    <td class="editable-cell" data-field="dob" data-playercode="${playercodeStr}">${dob}</td>
                    <td class="editable-cell" data-field="address" data-playercode="${playercodeStr}">${cliente.address}</td>
                    <td class="editable-cell" data-field="zip" data-playercode="${playercodeStr}">${cliente.zip}</td>
                    <td class="editable-cell" data-field="actividadEconomica" data-playercode="${playercodeStr}">${cliente.actividadEconomica || '8230300'}</td>
                `;
            });
            
            // Agregar listeners para edici√≥n
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('click', function() {
                    editarCelda(this);
                });
            });
            
            // Agregar listeners para checkboxes
            document.querySelectorAll('.kyc-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', actualizarContadorSeleccionados);
            });
            
            // Resetear checkbox de seleccionar todos
            const selectAll = document.getElementById('selectAllKYC');
            if (selectAll) {
                selectAll.checked = false;
            }
            actualizarContadorSeleccionados();
        }
        
        // Actualizar contador de seleccionados
        function actualizarContadorSeleccionados() {
            const checkboxes = document.querySelectorAll('.kyc-checkbox:checked');
            const contador = checkboxes.length;
            const texto = contador === 1 ? '1 seleccionado' : `${contador} seleccionados`;
            document.getElementById('contadorSeleccionados').textContent = texto;
        }
        
        // Toggle seleccionar todos
        function toggleSeleccionarTodos() {
            const selectAll = document.getElementById('selectAllKYC');
            const checkboxes = document.querySelectorAll('.kyc-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            actualizarContadorSeleccionados();
        }
        
        // Seleccionar todos KYC
        function seleccionarTodosKYC() {
            const selectAll = document.getElementById('selectAllKYC');
            if (selectAll) {
                selectAll.checked = true;
                toggleSeleccionarTodos();
            }
        }
        
        // Limpiar seleccionados KYC
        function limpiarSeleccionadosKYC() {
            const checkboxes = document.querySelectorAll('.kyc-checkbox:checked');
            
            if (checkboxes.length === 0) {
                mostrarAlerta('Por favor, selecciona al menos un cliente para limpiar', 'warning');
                return;
            }
            
            if (!confirm(`¬øEst√°s seguro de que deseas LIMPIAR los datos de ${checkboxes.length} cliente(s)?\n\nSe mantendr√° el registro pero se borrar√°n los campos editables (RFC, CURP, direcci√≥n, etc.).`)) {
                return;
            }
            
            try {
                let limpiadosCount = 0;
                
                checkboxes.forEach(checkbox => {
                    const playercode = checkbox.dataset.playercode;
                    if (padronKYC.has(playercode)) {
                        const cliente = padronKYC.get(playercode);
                        cliente.rfc = '';
                        cliente.curp = '';
                        cliente.address = '';
                        cliente.zip = '';
                        cliente.actividadEconomica = '8230300';
                        limpiadosCount++;
                    }
                });
                
                guardarPadronKYC();
                mostrarPadronKYC();
                mostrarAlerta(`‚úÖ ${limpiadosCount} cliente(s) limpiado(s) correctamente`, 'success');
            } catch (error) {
                console.error('Error al limpiar clientes:', error);
                mostrarAlerta('‚ùå Error al limpiar clientes: ' + error.message, 'danger');
            }
        }
        
        // Eliminar seleccionados KYC - VERSI√ìN ULTRA CORREGIDA
        function eliminarSeleccionadosKYC() {
            console.log('='.repeat(70));
            console.log('üóëÔ∏è INICIANDO ELIMINACI√ìN DE CLIENTES');
            console.log('='.repeat(70));
            
            const checkboxes = document.querySelectorAll('.kyc-checkbox:checked');
            console.log(`üìä Checkboxes seleccionados: ${checkboxes.length}`);
            
            if (checkboxes.length === 0) {
                mostrarAlerta('Por favor, selecciona al menos un cliente para eliminar', 'warning');
                return;
            }
            
            // Mostrar info de cada checkbox seleccionado
            checkboxes.forEach((cb, idx) => {
                console.log(`   Checkbox ${idx + 1}: playercode="${cb.dataset.playercode}"`);
            });
            
            console.log(`\nüì¶ Padr√≥n KYC antes de eliminar: ${padronKYC.size} registros`);
            console.log('   Primeros 5 playercodes en padr√≥n:', Array.from(padronKYC.keys()).slice(0, 5));
            
            if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de que deseas ELIMINAR permanentemente ${checkboxes.length} cliente(s) del padr√≥n?\n\nEsta acci√≥n NO se puede deshacer.`)) {
                console.log('‚ùå Eliminaci√≥n cancelada por el usuario');
                return;
            }
            
            try {
                let eliminadosCount = 0;
                const playercodes = [];
                
                // Recolectar playercodes
                checkboxes.forEach(checkbox => {
                    const playercode = checkbox.dataset.playercode;
                    playercodes.push(playercode);
                });
                
                console.log(`\nüìù Playercodes a eliminar (${playercodes.length}):`, playercodes);
                
                // Eliminar del Map
                playercodes.forEach(playercode => {
                    console.log(`   Buscando playercode="${playercode}" en padr√≥n...`);
                    
                    if (padronKYC.has(playercode)) {
                        padronKYC.delete(playercode);
                        eliminadosCount++;
                        console.log(`   ‚úÖ Eliminado exitosamente`);
                    } else {
                        console.log(`   ‚ö†Ô∏è NO ENCONTRADO en padr√≥n`);
                        console.log(`      Tipo del playercode: ${typeof playercode}`);
                        
                        // Buscar si existe con otro tipo
                        let encontrado = false;
                        for (let key of padronKYC.keys()) {
                            if (String(key) === String(playercode)) {
                                console.log(`      ¬°Encontrado con key="${key}" (tipo: ${typeof key})!`);
                                padronKYC.delete(key);
                                eliminadosCount++;
                                encontrado = true;
                                console.log(`      ‚úÖ Eliminado con conversi√≥n de tipo`);
                                break;
                            }
                        }
                        
                        if (!encontrado) {
                            console.log(`      ‚ùå No se pudo encontrar de ninguna forma`);
                        }
                    }
                });
                
                console.log(`\nüìä Resultado:`);
                console.log(`   Registros seleccionados: ${playercodes.length}`);
                console.log(`   Registros eliminados: ${eliminadosCount}`);
                console.log(`   Padr√≥n KYC despu√©s: ${padronKYC.size} registros`);
                console.log('='.repeat(70));
                
                // Guardar y actualizar
                guardarPadronKYC();
                mostrarPadronKYC();
                
                if (eliminadosCount > 0) {
                    mostrarAlerta(`‚úÖ ${eliminadosCount} cliente(s) eliminado(s) del padr√≥n`, 'success');
                } else {
                    mostrarAlerta(`‚ö†Ô∏è No se pudo eliminar ning√∫n registro. Revisa la consola (F12) para m√°s detalles.`, 'warning');
                }
            } catch (error) {
                console.error('‚ùå ERROR al eliminar clientes:', error);
                console.error('Stack trace:', error.stack);
                mostrarAlerta('‚ùå Error al eliminar clientes: ' + error.message, 'danger');
            }
        }
        
        // Editar celda
        function editarCelda(cell) {
            if (cell.classList.contains('editing-cell')) return;
            
            const originalValue = cell.textContent;
            const field = cell.dataset.field;
            const playercode = cell.dataset.playercode;
            
            cell.classList.add('editing-cell');
            cell.innerHTML = `<input type="text" value="${originalValue}" style="width: 100%; padding: 5px; border: 2px solid var(--primary); border-radius: 4px;">`;
            
            const input = cell.querySelector('input');
            input.focus();
            input.select();
            
            const guardarCambio = () => {
                const newValue = input.value.trim();
                cell.textContent = newValue;
                cell.classList.remove('editing-cell');
                
                // Actualizar padr√≥n
                if (padronKYC.has(playercode)) {
                    padronKYC.get(playercode)[field] = newValue;
                    guardarPadronKYC();
                    mostrarAlerta('‚úÖ Campo actualizado correctamente', 'success');
                }
            };
            
            input.addEventListener('blur', guardarCambio);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    guardarCambio();
                }
            });
        }
        
        // Generar XML UIF
        function generarXMLUIF() {
            const depositosAviso = datosDepositos.filter(d => d.estado === 'aviso');
            const retirosAviso = datosRetiros.filter(d => d.estado === 'aviso');
            
            if (depositosAviso.length === 0 && retirosAviso.length === 0) {
                mostrarAlerta('No hay operaciones que superen el umbral de 645 UMA', 'warning');
                return;
            }
            
            if (!periodoActual.year || !periodoActual.month) {
                mostrarAlerta('No se ha detectado el per√≠odo del reporte', 'danger');
                return;
            }
            
            const mesReportado = `${periodoActual.year}${String(periodoActual.month).padStart(2, '0')}`;
            const rfc = document.getElementById('rfcSujetoObligado').value;
            
            let archivosGenerados = 0;
            
            // Generar XML para DEP√ìSITOS
            if (depositosAviso.length > 0) {
                const xmlDepositos = generarXMLPorTipo(depositosAviso, 'depositos', mesReportado, rfc);
                const nombreArchivoDepositos = `AvisosLFPIORPI_${rfc}_${mesReportado}_DEPOSITOS.xml`;
                descargarArchivo(xmlDepositos, nombreArchivoDepositos, 'text/xml');
                guardarEnBancoReportes('XML UIF - Dep√≥sitos', nombreArchivoDepositos, depositosAviso.length);
                archivosGenerados++;
            }
            
            // Generar XML para RETIROS
            if (retirosAviso.length > 0) {
                const xmlRetiros = generarXMLPorTipo(retirosAviso, 'retiros', mesReportado, rfc);
                const nombreArchivoRetiros = `AvisosLFPIORPI_${rfc}_${mesReportado}_RETIROS.xml`;
                descargarArchivo(xmlRetiros, nombreArchivoRetiros, 'text/xml');
                guardarEnBancoReportes('XML UIF - Retiros', nombreArchivoRetiros, retirosAviso.length);
                archivosGenerados++;
            }
            
            mostrarAlerta(`‚úÖ ${archivosGenerados} archivo(s) XML generado(s): ${depositosAviso.length} dep√≥sitos, ${retirosAviso.length} retiros`, 'success');
        }
        
        // Generar XML por tipo
        function generarXMLPorTipo(operaciones, tipo, mesReportado, rfc) {
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xml += '<archivo xmlns="http://www.uif.shcp.gob.mx/recepcion/jys" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.uif.shcp.gob.mx/recepcion/jys jys.xsd">\n';
            xml += '  <informe>\n';
            xml += `    <mes_reportado>${mesReportado}</mes_reportado>\n`;
            xml += '    <sujeto_obligado>\n';
            xml += `      <clave_sujeto_obligado>${rfc}</clave_sujeto_obligado>\n`;
            xml += '      <clave_actividad>JYS</clave_actividad>\n';
            xml += '    </sujeto_obligado>\n';
            xml += '    <aviso>\n';
            xml += `      <referencia_aviso>${mesReportado}_${tipo.toUpperCase()}</referencia_aviso>\n`;
            xml += '      <prioridad>1</prioridad>\n';
            xml += '      <alerta>\n';
            xml += '        <tipo_alerta>100</tipo_alerta>\n';
            xml += '      </alerta>\n';
            
            // Agrupar operaciones por cliente
            const operacionesPorCliente = new Map();
            operaciones.forEach(op => {
                if (!operacionesPorCliente.has(op.playercode)) {
                    operacionesPorCliente.set(op.playercode, []);
                }
                operacionesPorCliente.get(op.playercode).push(op);
            });
            
            // Generar persona_aviso por cada cliente
            operacionesPorCliente.forEach((ops, playercode) => {
                const cliente = padronKYC.get(playercode) || ops[0];
                
                xml += '      <persona_aviso>\n';
                xml += '        <tipo_persona>\n';
                xml += '          <persona_fisica>\n';
                xml += `            <nombre>${cliente.firstname || 'X'}</nombre>\n`;
                
                const apellidos = (cliente.lastname || 'X').split(' ');
                xml += `            <apellido_paterno>${apellidos[0] || 'X'}</apellido_paterno>\n`;
                xml += `            <apellido_materno>${apellidos[1] || 'X'}</apellido_materno>\n`;
                
                const fechaNac = formatFechaNacimientoXML(cliente.dob);
                xml += `            <fecha_nacimiento>${fechaNac}</fecha_nacimiento>\n`;
                xml += `            <pais_nacionalidad>MX</pais_nacionalidad>\n`;
                xml += `            <actividad_economica>${cliente.actividadEconomica || '8230300'}</actividad_economica>\n`;
                xml += '          </persona_fisica>\n';
                xml += '        </tipo_persona>\n';
                
                // Domicilio
                if (cliente.address && cliente.address !== '') {
                    xml += '        <tipo_domicilio>\n';
                    xml += '          <nacional>\n';
                    xml += `            <calle>${cliente.address}</calle>\n`;
                    xml += `            <codigo_postal>${cliente.zip || '00000'}</codigo_postal>\n`;
                    xml += '          </nacional>\n';
                    xml += '        </tipo_domicilio>\n';
                }
                
                // Tel√©fono
                xml += '        <telefono>\n';
                xml += '          <clave_pais>MX</clave_pais>\n';
                xml += `          <numero_telefono>${cliente.phone || '+525500000000'}</numero_telefono>\n`;
                xml += `          <correo_electronico>${cliente.email ? cliente.email.toUpperCase() : 'N/A'}</correo_electronico>\n`;
                xml += '        </telefono>\n';
                xml += '      </persona_aviso>\n';
            });
            
            // Detalle de operaciones
            xml += '      <detalle_operaciones>\n';
            xml += '        <datos_operacion>\n';
            
            operaciones.forEach(op => {
                const ultimoDiaMes = new Date(op.year, op.month, 0).getDate();
                const fechaPago = `${op.year}${String(op.month).padStart(2, '0')}${String(ultimoDiaMes).padStart(2, '0')}`;
                
                xml += '          <datos_liquidacion>\n';
                xml += '            <liquidacion_numerario>\n';
                xml += `              <fecha_pago>${fechaPago}</fecha_pago>\n`;
                xml += '              <instrumento_monetario>8</instrumento_monetario>\n';
                xml += '              <moneda>1</moneda>\n';
                xml += `              <monto_operacion>${op.montoMensual.toFixed(2)}</monto_operacion>\n`;
                xml += '            </liquidacion_numerario>\n';
                xml += '          </datos_liquidacion>\n';
            });
            
            xml += '        </datos_operacion>\n';
            xml += '      </detalle_operaciones>\n';
            xml += '    </aviso>\n';
            xml += '  </informe>\n';
            xml += '</archivo>';
            
            return xml;
        }
        
        // Generar PDF de validaci√≥n
        function generarPDFValidacion() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(22);
            doc.text('Reporte de Validaci√≥n PLD/FT', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Per√≠odo: ${mesesNombre[periodoActual.month]} ${periodoActual.year}`, 105, 30, { align: 'center' });
            doc.text(`RFC: ${configuracion.rfcSujetoObligado}`, 105, 36, { align: 'center' });
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 105, 42, { align: 'center' });
            
            const depositosAviso = datosDepositos.filter(d => d.estado === 'aviso');
            const retirosAviso = datosRetiros.filter(d => d.estado === 'aviso');
            
            // Crear lista de clientes √∫nicos
            const clientesAvisoMap = new Map();
            
            depositosAviso.forEach(d => {
                if (!clientesAvisoMap.has(d.playercode)) {
                    clientesAvisoMap.set(d.playercode, {
                        playercode: d.playercode,
                        username: d.username,
                        nombre: `${d.firstname} ${d.lastname}`,
                        depositos: true,
                        retiros: false,
                        montoDepositos: d.montoMensual,
                        montoRetiros: 0
                    });
                } else {
                    const c = clientesAvisoMap.get(d.playercode);
                    c.depositos = true;
                    c.montoDepositos = d.montoMensual;
                }
            });
            
            retirosAviso.forEach(r => {
                if (!clientesAvisoMap.has(r.playercode)) {
                    clientesAvisoMap.set(r.playercode, {
                        playercode: r.playercode,
                        username: r.username,
                        nombre: `${r.firstname} ${r.lastname}`,
                        depositos: false,
                        retiros: true,
                        montoDepositos: 0,
                        montoRetiros: r.montoMensual
                    });
                } else {
                    const c = clientesAvisoMap.get(r.playercode);
                    c.retiros = true;
                    c.montoRetiros = r.montoMensual;
                }
            });
            
            const clientesUnicos = Array.from(clientesAvisoMap.values());
            
            let yPos = 55;
            doc.setFontSize(14);
            doc.text('Resumen Ejecutivo', 20, yPos);
            
            yPos += 10;
            doc.setFontSize(11);
            doc.text(`Total Dep√≥sitos: ${datosDepositos.length}`, 20, yPos);
            yPos += 6;
            doc.text(`Total Retiros: ${datosRetiros.length}`, 20, yPos);
            yPos += 6;
            doc.text(`Dep√≥sitos para Aviso: ${depositosAviso.length}`, 20, yPos);
            yPos += 6;
            doc.text(`Retiros para Aviso: ${retirosAviso.length}`, 20, yPos);
            yPos += 6;
            doc.text(`Clientes √önicos que Requieren Aviso: ${clientesUnicos.length}`, 20, yPos);
            
            // P√°gina de clientes √∫nicos
            if (clientesUnicos.length > 0) {
                doc.addPage();
                doc.setFontSize(14);
                doc.text('Clientes que Requieren Aviso', 20, 20);
                
                const datos = clientesUnicos.slice(0, 40).map(c => {
                    let categoria = '';
                    if (c.depositos && c.retiros) categoria = 'Dep√≥sitos y Retiros';
                    else if (c.depositos) categoria = 'Dep√≥sitos';
                    else categoria = 'Retiros';
                    
                    return [
                        c.username,
                        c.nombre,
                        categoria,
                        c.depositos ? formatCurrency(c.montoDepositos) : '-',
                        c.retiros ? formatCurrency(c.montoRetiros) : '-'
                    ];
                });
                
                doc.autoTable({
                    head: [['Usuario', 'Nombre', 'Categor√≠a', 'Monto Dep.', 'Monto Ret.']],
                    body: datos,
                    startY: 30,
                    theme: 'grid',
                    headStyles: { fillColor: [26, 77, 143] },
                    styles: { fontSize: 8 }
                });
            }
            
            const fileName = `Validacion_PLD_${periodoActual.year}${String(periodoActual.month).padStart(2, '0')}.pdf`;
            doc.save(fileName);
            
            guardarEnBancoReportes('PDF Validaci√≥n', fileName, clientesUnicos.length);
            mostrarAlerta(`‚úÖ PDF generado con ${clientesUnicos.length} clientes √∫nicos`, 'success');
        }
        
        // Generar reporte completo
        function generarReporteCompleto() {
            generarXMLUIF();
            generarPDFValidacion();
            exportarOperaciones('depositos', 'excel');
            exportarOperaciones('retiros', 'excel');
            exportarKYC('excel');
            
            mostrarAlerta('‚úÖ Reporte completo generado: 2 XML, PDF y Excel', 'success');
        }
        
        // Exportar operaciones
        function exportarOperaciones(tipo, formato) {
            const datos = tipo === 'depositos' ? datosDepositos : datosRetiros;
            
            if (datos.length === 0) {
                mostrarAlerta('No hay datos para exportar', 'warning');
                return;
            }
            
            const wsData = datos.map(d => ({
                'Usuario': d.username,
                'Nombre': `${d.firstname} ${d.lastname}`,
                'Email': d.email,
                'Tel√©fono': d.phone,
                'RFC': d.rfc,
                'CURP': d.curp,
                'Monto Mensual': d.montoMensual,
                'Monto Total': d.montoTotal,
                'UMA Equivalente': d.umaEquivalente.toFixed(2),
                'Veces Umbral': d.vecesUmbral,
                'Estado': getEstadoTexto(d.estado)
            }));
            
            const ws = XLSX.utils.json_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, tipo);
            
            const fileName = `${tipo}_${periodoActual.year}_${String(periodoActual.month).padStart(2, '0')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            mostrarAlerta('‚úÖ Excel exportado correctamente', 'success');
        }
        
        // Exportar KYC
        function exportarKYC(formato) {
            if (padronKYC.size === 0) {
                mostrarAlerta('El padr√≥n KYC est√° vac√≠o', 'warning');
                return;
            }
            
            if (formato === 'excel') {
                const datos = Array.from(padronKYC.values()).map(c => {
                    const camposCompletos = 
                        c.firstname && c.lastname && c.email && c.phone && 
                        c.rfc && c.curp && c.dob && c.address && c.zip;
                    
                    return {
                        'Estado': camposCompletos ? 'Completo' : 'Incompleto',
                        'ID Usuario': c.playercode,
                        'Usuario': c.username,
                        'Nombre': c.firstname,
                        'Apellidos': c.lastname,
                        'Email': c.email,
                        'Tel√©fono': c.phone,
                        'RFC': c.rfc,
                        'CURP': c.curp,
                        'Fecha Nacimiento': formatFechaNacimiento(c.dob),
                        'Direcci√≥n': c.address,
                        'C√≥digo Postal': c.zip,
                        'Actividad Econ√≥mica': c.actividadEconomica || '8230300'
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(datos);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Padr√≥n KYC');
                
                XLSX.writeFile(wb, `Padron_KYC_${new Date().toISOString().split('T')[0]}.xlsx`);
                mostrarAlerta('‚úÖ Padr√≥n KYC exportado a Excel', 'success');
            }
        }
        
        // Guardar en banco de reportes
        function guardarEnBancoReportes(tipo, nombreArchivo, numOperaciones) {
            const reporte = {
                id: Date.now(),
                tipo: tipo,
                nombreArchivo: nombreArchivo,
                fecha: new Date().toISOString(),
                periodo: `${periodoActual.year}-${String(periodoActual.month).padStart(2, '0')}`,
                numOperaciones: numOperaciones,
                rfcSujeto: configuracion.rfcSujetoObligado
            };
            
            bancoReportes.unshift(reporte);
            localStorage.setItem('bancoReportes', JSON.stringify(bancoReportes));
            
            actualizarBancoReportes();
        }
        
        // Actualizar banco de reportes
        function actualizarBancoReportes() {
            const container = document.getElementById('reportesContainer');
            document.getElementById('totalReportes').textContent = `${bancoReportes.length} reportes`;
            
            if (bancoReportes.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #7f8c8d;">No hay reportes almacenados.</p>';
                return;
            }
            
            container.innerHTML = '';
            
            bancoReportes.forEach(reporte => {
                const card = document.createElement('div');
                card.className = 'report-card';
                card.innerHTML = `
                    <div class="report-header">
                        <div class="report-title">${reporte.tipo} - ${reporte.periodo}</div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div class="report-date">${new Date(reporte.fecha).toLocaleString()}</div>
                            <button class="btn btn-danger" style="padding: 5px 12px; font-size: 0.85em;" onclick="eliminarReporte(${reporte.id})">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9em;">
                        <div><strong>Archivo:</strong> ${reporte.nombreArchivo}</div>
                        <div><strong>Operaciones:</strong> ${reporte.numOperaciones}</div>
                        <div><strong>RFC:</strong> ${reporte.rfcSujeto}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Eliminar reporte
        function eliminarReporte(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este reporte?')) {
                return;
            }
            
            bancoReportes = bancoReportes.filter(r => r.id !== id);
            localStorage.setItem('bancoReportes', JSON.stringify(bancoReportes));
            
            actualizarBancoReportes();
            mostrarAlerta('‚úÖ Reporte eliminado', 'success');
        }
        
        // Cargar banco de reportes
        function cargarBancoReportes() {
            const stored = localStorage.getItem('bancoReportes');
            if (stored) {
                bancoReportes = JSON.parse(stored);
                actualizarBancoReportes();
            }
        }
        
        // Cargar reportes hist√≥ricos
        function cargarReportesHistoricos() {
            actualizarBancoReportes();
            mostrarAlerta('‚úÖ Lista actualizada', 'info');
        }
        
        // Exportar banco completo
        function exportarBancoReportes() {
            if (bancoReportes.length === 0) {
                mostrarAlerta('No hay reportes para exportar', 'warning');
                return;
            }
            
            const wsData = bancoReportes.map(r => ({
                'Tipo': r.tipo,
                'Archivo': r.nombreArchivo,
                'Fecha': new Date(r.fecha).toLocaleString(),
                'Per√≠odo': r.periodo,
                'Operaciones': r.numOperaciones,
                'RFC': r.rfcSujeto
            }));
            
            const ws = XLSX.utils.json_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Banco Reportes');
            
            XLSX.writeFile(wb, `Banco_Reportes_${new Date().toISOString().split('T')[0]}.xlsx`);
            mostrarAlerta('‚úÖ Banco exportado', 'success');
        }
        
        // Filtrar tabla
        function filtrarTabla(tableId, searchId) {
            const input = document.getElementById(searchId);
            const filter = input.value.toUpperCase();
            const table = document.getElementById(tableId);
            const tr = table.getElementsByTagName('tr');
            
            for (let i = 1; i < tr.length; i++) {
                let found = false;
                const td = tr[i].getElementsByTagName('td');
                
                for (let j = 0; j < td.length; j++) {
                    if (td[j]) {
                        const txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }
                
                tr[i].style.display = found ? '' : 'none';
            }
        }
        
        // Limpiar datos
        function limpiarDatos() {
            if (!confirm('¬øEst√°s seguro de que deseas limpiar todos los datos?')) {
                return;
            }
            
            datosDepositos = [];
            datosRetiros = [];
            document.getElementById('fileExcel').value = '';
            document.getElementById('infoExcel').classList.add('hidden');
            
            document.getElementById('depositosBody').innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">Sin datos</td></tr>';
            document.getElementById('retirosBody').innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">Sin datos</td></tr>';
            
            document.getElementById('totalDepositos').textContent = '0';
            document.getElementById('totalRetiros').textContent = '0';
            document.getElementById('totalParaAviso').textContent = '0';
            
            mostrarAlerta('‚úÖ Datos limpiados', 'info');
        }
        
        // Guardar configuraci√≥n
        function guardarConfiguracion() {
            configuracion.rfcSujetoObligado = document.getElementById('rfcSujetoObligado').value;
            configuracion.razonSocial = document.getElementById('razonSocial').value;
            configuracion.year = parseInt(document.getElementById('yearSelect').value);
            configuracion.umaValue = parseFloat(document.getElementById('umaValue').value);
            configuracion.thresholdAviso = parseInt(document.getElementById('thresholdAviso').value);
            configuracion.thresholdMonitoreo = parseInt(document.getElementById('thresholdMonitoreo').value);
            configuracion.responsableCumplimiento = document.getElementById('responsableCumplimiento').value;
            
            localStorage.setItem('configuracionPLD', JSON.stringify(configuracion));
            calcularUmbrales();
            mostrarAlerta('‚úÖ Configuraci√≥n guardada', 'success');
        }
        
        // Cargar configuraci√≥n
        function cargarConfiguracion() {
            const stored = localStorage.getItem('configuracionPLD');
            if (stored) {
                configuracion = JSON.parse(stored);
                document.getElementById('rfcSujetoObligado').value = configuracion.rfcSujetoObligado;
                document.getElementById('razonSocial').value = configuracion.razonSocial;
                document.getElementById('yearSelect').value = configuracion.year;
                document.getElementById('umaValue').value = configuracion.umaValue;
                document.getElementById('thresholdAviso').value = configuracion.thresholdAviso;
                document.getElementById('thresholdMonitoreo').value = configuracion.thresholdMonitoreo || 325;
                document.getElementById('responsableCumplimiento').value = configuracion.responsableCumplimiento;
                calcularUmbrales();
            }
        }
        
        // Guardar padr√≥n KYC
        function guardarPadronKYC() {
            const padronArray = Array.from(padronKYC.entries());
            localStorage.setItem('padronKYC', JSON.stringify(padronArray));
        }
        
        // Cargar padr√≥n KYC
        function cargarPadronKYC() {
            const stored = localStorage.getItem('padronKYC');
            if (stored) {
                const padronArray = JSON.parse(stored);
                padronKYC = new Map(padronArray);
                mostrarPadronKYC();
            }
        }
        
        // Utilidades
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        }
        
        function getEstadoTexto(estado) {
            return estado === 'aviso' ? 'Requiere Aviso' : 'Normal';
        }
        
        function formatFechaNacimiento(dob) {
            if (!dob) return '';
            try {
                const fecha = new Date(dob);
                return fecha.toISOString().split('T')[0];
            } catch (e) {
                return dob;
            }
        }
        
        function formatFechaNacimientoXML(dob) {
            if (!dob) return '19700101';
            try {
                const fecha = new Date(dob);
                const year = fecha.getFullYear();
                const month = String(fecha.getMonth() + 1).padStart(2, '0');
                const day = String(fecha.getDate()).padStart(2, '0');
                return `${year}${month}${day}`;
            } catch (e) {
                return '19700101';
            }
        }
        
        function descargarArchivo(contenido, nombreArchivo, tipoMIME) {
            const blob = new Blob([contenido], { type: tipoMIME });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nombreArchivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function mostrarAlerta(mensaje, tipo) {
            const alertaExistente = document.querySelector('.alert-temporal');
            if (alertaExistente) {
                alertaExistente.remove();
            }
            
            const iconos = {
                'success': '‚úÖ',
                'danger': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo} alert-temporal`;
            alerta.style.position = 'fixed';
            alerta.style.top = '20px';
            alerta.style.right = '20px';
            alerta.style.zIndex = '10000';
            alerta.style.minWidth = '350px';
            alerta.style.maxWidth = '500px';
            alerta.style.animation = 'slideIn 0.3s ease';
            alerta.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
            alerta.innerHTML = `<strong>${iconos[tipo]}</strong> ${mensaje}`;
            
            document.body.appendChild(alerta);
            
            setTimeout(() => {
                alerta.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => alerta.remove(), 300);
            }, 4000);
        }
        
        // Animaciones
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
